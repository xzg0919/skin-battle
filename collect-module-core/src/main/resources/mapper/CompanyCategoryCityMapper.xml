<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.tzj.collect.core.mapper.CompanyCategoryCityMapper" >



    <select id="getCityHouseHoldDetail" parameterType="String" resultType="com.tzj.collect.core.result.business.CategoryResult">
		SELECT
			sc.name_,
			sc.id,
			IF(scc.price is NULL,IF(a.price is NULL,sc.price,a.price),scc.price) AS price,
			sc.unit
		FROM
			sb_company_category_city_name vv
		LEFT JOIN sb_company_category_city scc ON scc.company_id = vv.company_id AND scc.city_id = vv.city_id AND scc.category_id = vv.category_id
		LEFT JOIN (SELECT * FROM sb_category_city a WHERE a.city_id = #{cityId} AND a.parent_id = #{parentId} ) a ON a.category_id = vv.category_id
		LEFT JOIN sb_category sc ON vv.category_id = sc.id
		WHERE
				vv.`parent_id` = #{parentId}
		AND vv.`company_id` = #{companyId}
		AND vv.city_id = #{cityId}
    </select>

    <select id="getOwnnerPriceBycityId" parameterType="String" resultType="com.tzj.collect.core.result.ali.ComCatePrice">
        SELECT
			FORMAT(sccp.price,2) AS price,
			sccp.unit,
			sc.name_,
			sc.id,
			sc.icon,
			b.name_ AS parentName,
			b.id AS parentId,
			sc.is_old_exchange_new AS isOldExchangeNew,
			sc.ant_forest_pic AS antForestPic
		FROM
			sb_company_category_city sccp
		INNER JOIN sb_category sc ON sc.id = sccp.category_id
		LEFT JOIN sb_category b
		ON sc.parent_id = b.id
		WHERE
			sccp.parent_id = #{categoryId}
		AND sccp.company_id = #{companyId}
		AND sccp.price > 0
		AND sccp.del_flag = 0
		AND sccp.city_id = #{cityId}
		AND b.del_flag = 0
		ORDER BY sc.code_ ASC;
    </select>

    <select id="getOwnnerNoPriceBycityId" parameterType="String" resultType="com.tzj.collect.core.result.ali.ComCatePrice">
        SELECT
			FORMAT(sccp.price,2) AS price,
			sccp.unit,
			sc.name_,
			sc.id,
			sc.icon,
			b.name_ AS parentName,
			b.id AS parentId,
			sc.is_old_exchange_new AS isOldExchangeNew,
			sc.ant_forest_pic AS antForestPic
		FROM
			sb_company_category_city sccp
		INNER JOIN sb_category sc ON sc.id = sccp.category_id
		LEFT JOIN sb_category b
		ON sc.parent_id = b.id
		WHERE
			sccp.parent_id = #{categoryId}
		AND sccp.company_id = #{companyId}
		AND sccp.price = 0
		AND sccp.del_flag = 0
		AND sccp.city_id = #{cityId}
		AND b.del_flag = 0
		ORDER BY sc.code_ ASC;
    </select>

	<select id="topListAppByCity" resultType="com.tzj.collect.entity.Category" parameterType="String">
		SELECT DISTINCT
			scc.*
		FROM
			sb_category scc
		LEFT JOIN (SELECT sccc.id AS aId,sccc.price AS aprice,sccc.parent_id AS aparentId FROM sb_company_category_city sccc WHERE sccc.company_id = #{companyId} AND sccc.city_id = #{cityId} ) sccc ON sccc.aparentId = scc.id
		LEFT JOIN (SELECT sc.id AS bId,sc.price AS bprice,sc.parent_id AS bparentId FROM sb_company_category sc WHERE sc.company_id = #{companyId} AND sc.del_flag = 0) sc ON sc.bparentId = scc.id
		WHERE
			scc.title = #{title}
		AND scc.level_ = #{level}
		AND(sccc.aprice > 0 OR (sccc.aId is null AND sc.bprice >0))
		UNION ALL
		SELECT DISTINCT
			a.*
		FROM
			sb_category a
		WHERE
			a.level_ = #{level}
		AND a.title = #{title}
		AND a.unuseful = '1'
	 </select>
	<select id="getOneCategoryListByOrder" resultType="com.tzj.collect.entity.Category" parameterType="Integer">
		SELECT DISTINCT
			scc.*
		FROM
			sb_category scc
		LEFT JOIN (SELECT sccc.id AS aId,sccc.price AS aprice,sccc.parent_id AS aparentId FROM sb_company_category_city sccc WHERE sccc.company_id = #{companyId} AND sccc.city_id = #{cityId} ) sccc ON sccc.aparentId = scc.id
		LEFT JOIN (SELECT sc.id AS bId,sc.price AS bprice,sc.parent_id AS bparentId FROM sb_company_category sc WHERE sc.company_id = #{companyId} AND sc.del_flag = 0) sc ON sc.bparentId = scc.id
		WHERE
			scc.title = '2'
		AND scc.level_ = '0'
		AND scc.unuseful = '0'
		AND(sccc.aId is not NULL OR sc.bId is NOT null)
	 </select>

	<select id="getOwnnerPriceAppByCity" parameterType="String" resultType="com.tzj.collect.core.result.ali.ComCatePrice">
		SELECT
			FORMAT(sccp.price,2) AS price,
			sccp.unit,
			sc.name_,
			sc.id,
			sc.icon
		FROM
			sb_company_category_city sccp
		INNER JOIN sb_category sc ON sc.id = sccp.category_id
		WHERE
			sccp.parent_id = #{categoryId}
		AND sccp.company_id = #{companyId}
		AND sccp.del_flag = 0
		AND sc.del_flag = 0
		AND sccp.city_id = #{cityId}
		ORDER BY sc.code_ ASC
	</select>
	<select id="getCompanyCategoryListByCityTitle" parameterType="Integer" resultType="Map">
		SELECT
			a.id,
			a.name_ AS name,
			a.icon,
			IF(b.price is NULL,a.price,b.price) AS price,
			IF(b.price is NULL,a.price,b.price) AS price,
			IF(c.admin_commissions is NULL,a.admin_commissions,c.admin_commissions) AS adminCommissions,
			IF(c.free_commissions is NULL,a.free_commissions,c.free_commissions) AS freeCommissions,
			IF(c.company_commissions is NULL,a.company_commissions,c.company_commissions) AS companyCommissions
		FROM
			sb_category a
		LEFT JOIN (SELECT * FROM sb_company_category_city a WHERE a.city_id = #{cityId} AND a.company_id = #{companyId} AND a.parent_id = #{categoryId}) b ON a.id = b.category_id
		LEFT JOIN (SELECT * FROM sb_company_category a WHERE a.company_id = #{companyId} AND a.parent_id = #{categoryId}) c ON c.category_id = a.id
		WHERE
			a.parent_id = #{categoryId}
	</select>
	<select id="getCompanyCategoryAttrOptionCityLists" parameterType="Integer" resultType="Map">
		SELECT
			a.id,
			a.name_ AS name,
			IF(b.attr_option_price is null,a.price,b.attr_option_price) AS price,
			if(b.is_special is NULL,'0',b.is_special) AS isSpecial,
			if(b.is_recovery is NULL,'0',b.is_recovery) AS isRecovery,
			if(b.special_price is NULL,a.special_price,b.special_price) AS specialPrice
		FROM
			sb_category_attr_option a
		LEFT JOIN ( SELECT * FROM sb_company_category_attr_option_city a WHERE a.city_id = #{cityId} AND a.company_id = #{companyId}) b ON a.id = b.category_attr_option_id
		WHERE
			a.category_attr_id = #{categoryAttrId}
	</select>
	<select id="selectCategoryCount" parameterType="Object" resultType="Integer">
		SELECT
			COUNT(1)
		FROM
			sb_company_category a
		INNER JOIN sb_category b ON a.category_id = b.id
		WHERE
			b.title = #{title}
		AND a.company_id = #{companyId}
	</select>
</mapper>
