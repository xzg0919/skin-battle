<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.tzj.collect.core.mapper.OrderMapper">

	<update id="deleteBigOrderRemarks" parameterType="Integer" >
		UPDATE sb_order
		SET order_remarks = NULL
		WHERE
			id = #{orderId}
	</update>
	
	<select id="getUncompleteList" parameterType="String" resultMap="OrderResultMap">
        SELECT <include refid="zd"/>,c.parent_id AS categoryId FROM sb_order a  LEFT JOIN sb_category c ON a.category_id = c.id WHERE a.ali_user_id = #{aliUserId} AND a.del_flag = '0' AND a.status_ IN (0,1,2)  ORDER BY a.create_date DESC
    </select> 
    <select id="getOrderlist" parameterType="Object" resultMap="OrderResultMap">
		SELECT
		<include refid="zd"/>, d.price AS paymentPrice,
		c.parent_id AS categoryId
		FROM
		sb_order a
		LEFT JOIN sb_category c ON a.category_id = c.id
		LEFT JOIN sb_payment d ON a.order_no = d.order_sn
		WHERE
		a.ali_user_id = #{aliUserId}
		AND a.del_flag = '0'
		<if test="status != -1">
			<choose>
				<when test="status == 0">
					AND a.status_ IN (0,1)
				</when>
				<otherwise>
					AND a.status_ = #{status}
				</otherwise>
			</choose>
		</if>
		ORDER BY
		a.create_date DESC
		LIMIT #{sizeStart} , #{size}
    </select>
    <select id="selectOrder" parameterType="int" resultMap="OrderResultMap">  
        SELECT <include refid="zd"/>,b.name_ AS Recyclers_name,b.tel AS BTel,b.head_pic_url AS headPicUrl,e.price AS paymentPrice FROM sb_order a  LEFT JOIN sb_category c ON a.category_id = c.id LEFT JOIN sb_recyclers b ON b.id = a.recycler_id LEFT JOIN sb_payment e ON a.order_no = e.order_sn WHERE a.id = #{orderId} AND a.del_flag = '0'  ORDER BY a.create_date DESC
    </select> 
    <select id="getOrderListsCount" parameterType="Object" resultType="Integer">
		SELECT COUNT(1) FROM (
			SELECT
				a.*
			FROM
			sb_order a
			LEFT JOIN sb_category c ON a.category_id = c.id
			LEFT JOIN sb_payment p ON p.order_sn = a.order_no
			LEFT JOIN sb_recyclers b ON a.recycler_id = b.id
			LEFT JOIN (
			SELECT
			d.order_id,
			max(d.num) AS num
			FROM
			sb_arrival_time_log d
			LEFT JOIN sb_order a ON d.order_id = a.id
			GROUP BY
			d.order_id
			) f ON a.id = f.order_id
			WHERE
			a.del_flag = '0'
			AND (a.order_from = '0' or a.order_from is null)
			AND a.company_id =#{companyId} AND a.is_scan = #{isScan}
			<if test="status != null">
				AND  a.status_ in
				<foreach collection="status" index="index" item="item" open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
			<if test="orderNo != null and orderNo !='' ">
				AND a.order_no LIKE concat(concat('%',#{orderNo}),'%')
			</if>
			<if test="linkMan != null and linkMan !='' ">
				AND a.link_man LIKE concat(concat('%',#{linkMan}),'%')
			</if>
			<if test="recyclersName !=null and recyclersName!='' ">
				<choose>
					<when test="title == 3">
						and a.express_name LIKE concat(concat('%',#{recyclersName}),'%')
					</when>
					<otherwise>
						AND (b.name_ LIKE concat(concat('%',#{recyclersName}),'%'))
					</otherwise>
				</choose>
			</if>
			<if test="startTime !=null and startTime !=''">
				<![CDATA[
						AND a.complete_date >= CONCAT(#{startTime},' 00:00:00')
					 ]]>
			</if>
			<if test="endTime !=null and endTime !=''">
				<![CDATA[
						AND a.complete_date <= CONCAT(#{endTime},' 23:59:59')
					 ]]>
			</if>
			<if test="title != null and title !='' ">
				AND a.title  = #{title}
			</if>
			GROUP BY a.id
		)a
    	</select>
    <select id="getOrderLists" parameterType="Object" resultMap="OrderResultMap">
			select * from (
				select a.*,IF(0>a.overTimes,-1,a.overTimes) AS overTime, IF(a.overTimes > 2880,'1',if(a.complaint_type = '3','1','0')) AS isComplaint from (
					SELECT
					<include refid="zd"/>, b.name_ AS Recyclers_name,
					b.tel AS BTel,
					f.num,
					p.price AS paymentPrice,
					d.cancle_reason AS examineReason,
					d.status_ AS examineStatus,
					TIMESTAMPDIFF(MINUTE, IF(a.arrival_period='pm',CONCAT(a.arrival_time,' 18:00:00'),IF(a.arrival_period='am',CONCAT(a.arrival_time,' 12:00:00'),CONCAT(a.arrival_time,' ',SUBSTR(a.arrival_period, 7,5),':00'))),IF(a.status_ = '3',a.complete_date,if(a.status_ in ('4','5'),a.cancel_time,NOW()))) AS overTimes
					FROM
					sb_order a
					LEFT JOIN sb_category c ON a.category_id = c.id
					LEFT JOIN sb_payment p ON p.order_sn = a.order_no
					LEFT JOIN sb_recyclers b ON a.recycler_id = b.id
					LEFT JOIN sb_order_cancle_examine d ON a.order_no = d.order_no
					LEFT JOIN (
					SELECT
					d.order_id,
					COUNT(1) AS num
					FROM
					sb_arrival_time_log d
					LEFT JOIN sb_order a ON d.order_id = a.id
					GROUP BY
					d.order_id
					) f ON a.id = f.order_id
					WHERE
					a.del_flag = '0'
					AND (a.order_from = '0' or a.order_from is null)
					AND a.company_id =#{companyId} AND a.is_scan = #{isScan}
					<if test="status != null">
						AND  a.status_ in
						<foreach collection="status" index="index" item="item" open="(" separator="," close=")">
							#{item}
						</foreach>
					</if>
					<if test="orderNo != null and orderNo !='' ">
						AND a.order_no LIKE concat(concat('%',#{orderNo}),'%')
					</if>
					<if test="linkMan != null and linkMan !='' ">
						AND a.link_man LIKE concat(concat('%',#{linkMan}),'%')
					</if>
					<if test="recyclersName !=null and recyclersName!='' ">
						<choose>
							<when test="title == 3">
								and a.express_name LIKE concat(concat('%',#{recyclersName}),'%')
							</when>
							<otherwise>
								AND (b.name_ LIKE concat(concat('%',#{recyclersName}),'%'))
							</otherwise>
						</choose>
					</if>
					<if test="startTime !=null and startTime !=''">
						<![CDATA[
							AND a.complete_date >= CONCAT(#{startTime},' 00:00:00')
						 ]]>
					</if>
					<if test="endTime !=null and endTime !=''">
						<![CDATA[
							AND a.complete_date <= CONCAT(#{endTime},' 23:59:59')
						 ]]>
					</if>
					<if test="title != null and title !='' ">
						AND a.title  = #{title}
					</if>
					GROUP BY a.id
				)a
			)a
		ORDER BY a.isComplaint DESC, IF(a.status_='3',a.complete_date,if(a.status_ in ('4','5'),a.cancel_time,a.overTime)) DESC ,a.create_date DESC
		LIMIT #{startSize} , #{pageSize}
    	</select>
    	
    <select id="getAppOrderList" parameterType="com.tzj.collect.core.param.ali.OrderBean" resultType="com.tzj.collect.core.result.app.AppOrderResult">
	    select * from (
			select so.*,IF(0>so.overTimes,-1,so.overTimes) AS overTime,IF(so.overTimes > 2880,'1',if(so.complaintType = '3','1','0')) AS isComplaint from (
			SELECT
				so.id AS orderId,
				so.create_date AS creatDate,
				so.address,
				so.link_man AS linkName,
				so.tel,
				so.full_address,
				so.status_,
				FORMAT(so.price, 2) AS price,
				so.ach_price AS achPrice,
				so.order_no orderNo,
				date_format(IF(ISNULL(so.arrival_time),"",so.arrival_time), '%Y-%m-%d') AS arrivalTime,
				so.arrival_period,
				sc.name_ AS cateName,
				sc.icon,
				so.cancel_reason as cancelReason,
				so.complete_date completeDate,
				so.title,
				so.community_id,
				so.company_id,
				so.is_cash,
				so.order_remarks,
				so.complaint_type as complaintType,
				so.is_item_ach as isItemAch,
				bb.is_manager as isManager,
				TIMESTAMPDIFF(MINUTE, IF(so.title = '2',CONCAT(so.arrival_time,' ',SUBSTR(so.arrival_period, 7,5),':00'),IF(so.arrival_period='am',CONCAT(so.arrival_time,' 12:00:00'),CONCAT(so.arrival_time,' 18:00:00'))), IF(so.status_ = '3',so.complete_date,if(so.status_ in ('4','5'),so.cancel_time,NOW()))) AS overTimes
			FROM
				 sb_order so
			LEFT JOIN sb_category sc ON so.category_id = sc.id
			LEFT JOIN sb_recyclers sr ON sr.id = so.recycler_id
			LEFT JOIN sb_company_recycler bb ON bb.recycler_id = so.recycler_id AND so.company_id = bb.company_id
			WHERE
				so.del_flag = '0'
			AND so.order_from != '1'
				<if test="orderBean.recyclerId != null and orderBean.recyclerId != '' ">
					AND so.recycler_id = #{orderBean.recyclerId}
				</if>
				<if test="orderBean.status != null and orderBean.status != '' ">
					AND so.status_ = #{orderBean.status}
				</if>
				)so
		) so
		<choose>
			<when test="orderBean.status == '3'.toString()">
				ORDER BY so.completeDate DESC
			</when>
			<when test="orderBean.status == '2'.toString()">
				ORDER BY so.overTime DESC,so.arrivalTime ASC,so.arrival_period ASC,so.creatDate ASC
			</when>
			<when test="orderBean.status == '1'.toString()">
				ORDER BY so.overTime DESC,so.creatDate DESC
			</when>
			<otherwise>
				ORDER BY so.creatDate DESC
			</otherwise>
		</choose>
		LIMIT #{startSize} , #{pageSize}
    </select>
    
    <select id="getAppOrderCount" parameterType="com.tzj.collect.core.param.ali.OrderBean" resultType="Integer">
	    SELECT
			count(*)
		FROM
			sb_order so
		LEFT JOIN sb_category sc  ON so.category_id = sc.id
		WHERE
			so.del_flag = '0'
			<if test="orderBean.recyclerId != null and orderBean.recyclerId != '' ">
				AND so.recycler_id = #{orderBean.recyclerId}
			</if>
			<if test="orderBean.status != null and orderBean.status != '' ">
				AND so.status_ = #{orderBean.status}
			</if>
    </select>
    
    <select id="getAppOrderCancelTaskList" parameterType="com.tzj.collect.core.param.ali.OrderBean" resultType="com.tzj.collect.core.result.app.AppOrderResult">
	    SELECT
					so.id AS orderId,
					so.create_date AS creatDate,
					so.address,
					so.link_man AS linkName,
					so.tel,
					6 as status,
					so.price,
					so.order_no orderNo,
					so.complaint_type as complaintType,
					TIMESTAMPDIFF(MINUTE, IF(so.title = '2',CONCAT(so.arrival_time,' ',SUBSTR(so.arrival_period, 7,5),':00'),IF(so.arrival_period='am',CONCAT(so.arrival_time,' 12:00:00'),CONCAT(so.arrival_time,' 18:00:00'))), IF(so.status_ = '3',so.complete_date,if(so.status_ in ('4','5'),so.cancel_time,NOW()))) AS overTimes,
				date_format(IF(ISNULL(so.arrival_time),"",so.arrival_time), '%Y-%m-%d') AS arrivalTime,
				so.arrival_period AS arrivalPeriod,
				sc.name_ AS cateName,
				sc.icon,
				so.complete_date completeDate,
				so.title,
				so.is_cash,
				sr.is_manager
			FROM
				sb_category sc
			INNER JOIN sb_order so ON so.category_id = sc.id
			LEFT JOIN sb_recycle_cancel_log srcl ON srcl.order_id = so.id
			LEFT JOIN sb_recyclers sr ON sr.id = so.recycler_id
			WHERE
				so.del_flag = '0'
				AND so.order_from != '1'
		AND srcl.recycler_id = #{orderBean.recyclerId}
		GROUP BY so.id
			ORDER BY so.create_date DESC LIMIT #{startSize} , #{pageSize}
    </select>
    
     <select id="getAppOrderCancelTaskCount" parameterType="com.tzj.collect.core.param.ali.OrderBean" resultType="Integer">
	    SELECT
			COUNT(*)
		FROM
			(
				SELECT
					so.id AS orderId,
					so.create_date AS creatDate,
					so.address,
					so.link_man AS linkName,
					so.tel,
					so.status_,
					so.price,
					so.order_no orderNo,
				IF (
					ISNULL(so.arrival_time),
					"",
					so.arrival_time
				) AS arrivalTime,
				sc.name_ AS cateName,
				sc.icon,
				so.complete_date completeDate
			FROM
				sb_category sc
			INNER JOIN sb_order so ON so.category_id = sc.id
			WHERE
				so.del_flag = '0'
			<if test="orderBean.recyclerId != null and orderBean.recyclerId != '' ">
				AND so.recycler_id = #{orderBean.recyclerId}
			</if>
			) scso
		LEFT JOIN sb_order_log sol ON scso.orderId = sol.order_id
		WHERE
			sol.op_status_after = 'CANCELTASK'
    </select>
    <select id="getOrderDetails" parameterType="com.tzj.collect.core.param.ali.OrderBean" resultType="com.tzj.collect.core.result.app.AppOrderResult">
    	SELECT
			scomco.order_no AS orderNo,
			sc.name_ AS cateName,
			sc.icon,
			scomco.address,
			scomco.full_address AS fullAddress,
			date_format(IF(ISNULL(scomco.arrival_time),"",scomco.arrival_time), '%Y-%m-%d') AS arrivalTime,
			scomco.complete_date AS completeTime,
			scomco.link_man AS linkName,
			scomco.tel,
			scomco.id AS orderId,
			FORMAT(scomco.price, 2) AS price,
			scomco.ach_price AS achPrice,
			scomco.comTel,
			scomco.comName,
			scomco.status_,
			scomco.arrival_period AS arrivalPeriod,
			scomco.remarks,
			scomco.title,
			scomco.community_id,
			scomco.company_id,
			scomco.ach_remarks,
			scomco.is_cash,
			scomco.green_count,
			scomco.is_item_ach as isItemAch,
			sr.is_manager
		FROM
			(
				SELECT
					scom.name_ AS comName,
					scom.tel AS comTel,
					so.*
				FROM
					sb_company scom
				INNER JOIN sb_order so ON so.company_id = scom.id
				WHERE
					so.del_flag = '0'				
				<if test="orderBean.id != null and orderBean.id != '' ">
					AND so.id = #{orderBean.id}
				</if>
				) scomco
			LEFT JOIN sb_category sc ON sc.id = scomco.category_id
			LEFT JOIN sb_recyclers sr ON sr.id = scomco.recycler_id
    </select>
    <select id="getOrderItemList" parameterType="com.tzj.collect.core.param.ali.OrderBean" resultType="com.tzj.collect.core.result.app.AttrItem">
    	SELECT
			soi.category_attr_name AS cateAttrName,
			soi.category_attr_opption_name AS cateAttrOpp
		FROM
			sb_order_item soi
		WHERE
			soi.del_flag = '0'
		AND soi.order_id = #{orderBean.id}
    </select>
    
    <select id="getOrderUrlList" parameterType="com.tzj.collect.core.param.ali.OrderBean" resultType="com.tzj.collect.core.result.app.AttrItem">
    	SELECT
			sop.orig_pic AS origPic,
			sop.pic_url AS picUrl,
			sop.small_pic AS smallPic
		FROM
			sb_order_pic sop
		WHERE
			sop.del_flag = '0'
		AND sop.order_id = #{orderBean.id}
    </select>
    
    <select id="getOrderAchUrlList" parameterType="com.tzj.collect.core.param.ali.OrderBean" resultType="Map">
    	SELECT
			sop.orig_pic AS origPic,
			sop.pic_url AS picUrl,
			sop.small_pic AS smallPic
		FROM
			sb_order_pic_ach sop
		WHERE
			sop.del_flag = '0'
		AND sop.order_id = #{orderBean.id}
    </select>
    
    <select id="getRecord" parameterType="com.tzj.collect.core.param.ali.OrderBean" resultType="com.tzj.collect.core.result.app.AppOrderResult">
    
   		SELECT
			COUNT(*) AS currentNum,
			IF(ISNULL(SUM(so.price)),0,SUM(so.price)) AS currentSum,
			(
				SELECT
					SUM(so.price)
				FROM
					sb_order so
				WHERE
					so.del_flag = '0'
				AND so.status_ = '3'
				AND so.recycler_id = #{timeBean.recyclerId}
			) AS total,
			(
				SELECT
					COUNT(*)
				FROM
					sb_order so
				WHERE
					so.del_flag = '0'
				AND so.status_ = '3'
				AND so.recycler_id = #{timeBean.recyclerId}
			) AS countNum
		FROM
			sb_order so
		WHERE
			so.del_flag = '0'
		AND so.status_ = '3'
		AND so.recycler_id = #{timeBean.recyclerId}
		AND DATE_FORMAT(so.complete_date, '%Y%m') = DATE_FORMAT(#{timeBean.date}, '%Y%m')
    </select>
    
    <select id="getScore" parameterType="com.tzj.collect.core.param.app.ScoreAppBean" resultType="com.tzj.collect.core.result.app.EvaluationResult">
    	SELECT
			soe.score,
			soe.content,
			soe.create_by AS createBy,
			soe.create_date AS createDate
		FROM
			sb_order_evaluation soe
		WHERE
			soe.del_flag = '0'
		AND soe.recycler_id = #{scoreAppBean.recyclerId}
		<if test="scoreAppBean.score != null and scoreAppBean.score != '' ">
		AND soe.score in
			<foreach collection="scoreAppBean.scoreList" index="index" item="item" open="(" separator="," close=")">  
	        	#{item}  
	   		</foreach>  	
		</if>
		ORDER BY soe.create_date DESC LIMIT #{startSize} , #{pageSize}
    </select>
    
    <select id="getRecordNum" parameterType="com.tzj.collect.core.param.app.ScoreAppBean" resultType="Integer">
    
   		SELECT
			count(*)
		FROM
			sb_order_evaluation soe
		WHERE
			soe.del_flag = '0'
		AND soe.recycler_id = #{scoreAppBean.recyclerId}
		<if test="scoreAppBean.score != null and scoreAppBean.score != '' ">
		AND soe.score in
			<foreach collection="scoreAppBean.scoreList" index="index" item="item" open="(" separator="," close=")">  
	        	#{item}  
	   		</foreach>  	
		</if>
    </select>
    
    <select id="getEvaRate" parameterType="com.tzj.collect.core.param.app.ScoreAppBean" resultType="com.tzj.collect.core.result.app.AppScoreResult">
		SELECT
			(
				SELECT
					COUNT(soev.score)
				FROM
					sb_order_evaluation soev
				WHERE
					soev.del_flag = '0'
				AND soev.score <![CDATA[>=4 ]]>
				AND soev.recycler_id = #{scoreAppBean.recyclerId}
			) AS fiveNum,
			(
				SELECT
					COUNT(soev.score)
				FROM
					sb_order_evaluation soev
				WHERE
					soev.del_flag = '0'
				AND soev.score <![CDATA[<=2 ]]>
				AND soev.recycler_id = #{scoreAppBean.recyclerId}
			) AS oneNum,
			(
				SELECT
					COUNT(soev.score)
				FROM
					sb_order_evaluation soev
				WHERE
					soev.del_flag = '0'
				AND soev.score = 3
				AND soev.recycler_id = #{scoreAppBean.recyclerId}
			) AS threeNum,
			(
				SELECT
					COUNT(soev.score) / (
						SELECT
							COUNT(*)
						FROM
							sb_order_evaluation soev
						WHERE
							soev.del_flag = '0'
						AND soev.recycler_id = #{scoreAppBean.recyclerId}
					)
				FROM
					sb_order_evaluation soev
				WHERE
					soev.del_flag = '0'
				AND soev.score <![CDATA[>=4 ]]>
				AND soev.recycler_id = #{scoreAppBean.recyclerId}
			) AS fiveRate,
			(
				SELECT
					COUNT(soev.score) / (
						SELECT
							COUNT(*)
						FROM
							sb_order_evaluation soev
						WHERE
							soev.del_flag = '0'
						AND soev.recycler_id = #{scoreAppBean.recyclerId}
					)
				FROM
					sb_order_evaluation soev
				WHERE
					soev.del_flag = '0'
				AND soev.score <![CDATA[<=2 ]]>
				AND soev.recycler_id = #{scoreAppBean.recyclerId}
			) AS oneRate,
			IF(ISNULL(AVG(soev.score)),0, AVG(soev.score))  AS avgScore
		FROM
			sb_order_evaluation soev
		WHERE
			soev.del_flag = '0'
		AND soev.recycler_id = #{scoreAppBean.recyclerId}
    </select>
    <select id="getCommToken" resultType="com.tzj.collect.core.result.ali.CommToken" parameterType="String">
    	SELECT
			sr.tencent_token AS tencentToken,
			sosco.name_ AS commName
		FROM
			sb_recyclers sr
		INNER JOIN (
			SELECT
				so.id,
				sco.name_,
				so.recycler_id
			FROM
				sb_order so
			LEFT JOIN sb_community sco ON sco.id = so.community_id
			WHERE
				sco.del_flag = '0'
			AND so.order_no = #{orderNo}
		) sosco ON sosco.recycler_id = sr.id
		WHERE
			sr.del_flag = '0'
    </select>
    <select id="getDataBoard" parameterType="String" resultMap="OrderResultMap">  
        SELECT COUNT(*) AS member_id, SUM(a.price) AS company_id 
		FROM sb_order a 
		WHERE a.company_id = #{companyId} AND a.status_ = #{status} AND a.del_flag = '0'
    </select>
    <select id="getBrokenData" resultType="Map" parameterType="Object">
    	SELECT
			count(*) as 笔数,DATE_FORMAT((LEFT (create_date, 13)),'%H:%i' ) AS DATE,cast(sum(a.price) as decimal(15,2)) as 金额
		FROM
			sb_order a
		WHERE a.create_date BETWEEN  concat(#{startTime},' 00:00:00') AND  concat(#{startTime},' 23:59:59')
		AND a.status_ = 3 AND a.del_flag = '0' AND a.company_id = #{companyId}
		GROUP BY DATE
		ORDER BY DATE;
    </select>
     <select id="getBrokenWeek" resultType="Map" parameterType="Object">
    	SELECT
			count(*) as 笔数,DATE_FORMAT(LEFT (create_date, 10), '%m-%d') AS DATE,cast(sum(a.price) as decimal(15,2)) as 金额
		FROM
			sb_order a
		WHERE a.create_date BETWEEN  concat(#{endTime},' 00:00:00') AND  concat(#{startTime},' 23:59:59')
		AND a.status_ = 3 AND a.del_flag = '0' AND a.company_id = #{companyId}
		GROUP BY DATE
		ORDER BY DATE;
    </select>
    <select id="getBrokenMath" resultType="Map" parameterType="Object">
    	SELECT
			count(*) as 笔数,DATE_FORMAT(LEFT (create_date, 10), '%m-%d') AS DATE,cast(sum(a.price) as decimal(15,2)) as 金额
		FROM
			sb_order a
		WHERE
			a.status_ = 3 AND a.del_flag = '0' AND a.company_id = #{companyId}
		  AND  a.create_date BETWEEN  concat(#{endTime},' 00:00:00') AND  concat(#{startTime},' 23:59:59') and (CURDATE()- STR_TO_DATE(a.create_date,'%Y-%m-%d'))%3=0
		GROUP BY
			DATE;
    </select>
    
    <select id="selectCateName" resultType="com.tzj.collect.core.result.ali.ComCatePrice">
    	SELECT
			soi.parent_name as name,
			soi.parent_id as id
		FROM
			sb_order so
		LEFT JOIN sb_order_item soi ON so.id = soi.order_id
		WHERE
			so.id = #{orderId}
		GROUP BY
			parent_id
    </select>
     <select id="selectCateAchName" resultType="com.tzj.collect.core.result.ali.ComCatePrice">
    	SELECT
			soi.parent_name as name,
			soi.parent_id as id
		FROM
			sb_order so
		LEFT JOIN sb_order_item_ach soi ON so.id = soi.order_id
		WHERE
			so.id = #{orderId}
		GROUP BY
			parent_id
    </select>
	<select id="distributeOrderList" parameterType="Integer" resultType="Map">
	SELECT
		a.id AS recyclerId,
		a.name_ AS recyclerName,
		a.tel AS recyclerMobile,
		b.id,
		b.title,
		b.status_ AS orderStatus,
		b.link_man AS userName,
		b.tel AS userMobile,
		b.address AS address,
		b.price,
		b.is_cash AS isCash,
		b.order_no AS orderNo,
		b.category_id AS categoryId,
		date_format(b.create_date,'%Y-%m-%d %H:%i:%S') AS createDate,
		CONCAT('上门时间:',date_format(b.arrival_time,'%Y-%m-%d'),IF(b.arrival_period = 'am','上午',IF(b.arrival_period = 'pm','下午',CONCAT(' ',b.arrival_period))))AS arrivalTime,
		CONCAT('取消时间:',date_format(b.cancel_time,'%Y-%m-%d %H:%i:%S'))AS cancelTime,
		CONCAT('接单时间:',date_format(b.receive_time,'%Y-%m-%d %H:%i:%S'))AS receiveTime,
		CONCAT('派单时间:',date_format(b.distribute_time,'%Y-%m-%d %H:%i:%S')) AS distributeTime,
		CONCAT('完成时间:',date_format(b.complete_date,'%Y-%m-%d %H:%i:%S'))AS completeDate
	FROM
		sb_recyclers a
	LEFT JOIN sb_order b ON a.id = b.recycler_id
	LEFT JOIN sb_company_recycler c ON a.id = c.recycler_id
	WHERE
		c.parents_id = #{recyclerId}
	AND c.status_ = 1
	AND b.status_ in (1,2)
	AND a.del_flag = 0
	AND b.del_flag = 0
	AND b.is_scan = 0
	</select>

	<select id="paymentPriceByOrderId" parameterType="Integer" resultType="Object">
		SELECT distinct
			b.price
		FROM
			sb_order a
		LEFT JOIN sb_payment b ON b.order_sn = a.order_no
		WHERE
			a.id = #{orderId}
		AND b.seller_id is NOT NULL

	</select>

	<!--五废订单 -->
	<select id="orderDetail4HorseHold" parameterType="Object" resultType="Map">
		SELECT
		comId.order_no as orderNo,
		comId.dateFor as createDate,
		scc.name_ as company,
		comId.title as title,
		(SELECT (SELECT name_ from sb_category where id=c.parent_id) from sb_category  c where id=comId.category_id ) as firstCate,
		comId.category_name as secondCate,
		comId.cash as cash,
		comId.ach_price as price,
		comId.amount as weight,
		comId.adminCommissions,
		comId.backCommissionsPrice,
		comId.name_ as recycleName
		FROM
		sb_company scc
		RIGHT JOIN (
		SELECT
		soia.amount,
		soia.category_name,
		soia.category_id,
		soia.parent_name,
		dataInfo.*
		FROM
		sb_order_item_ach soia
		RIGHT JOIN (
		SELECT
		soo.order_no,
		soo.id,
		soo.admin_commissions AS adminCommissions,
		soo.back_commissions_price AS backCommissionsPrice,
		sr.name_,
		CASE soo.title
		WHEN 1 THEN
		'家电数码'
		WHEN 2 THEN
		'五废'
		WHEN 3 THEN
		'5公斤废纺衣物回收'
		WHEN 4 THEN
		'大件垃圾'
		ELSE
		'其他'
		END AS title,
		CASE soo.is_cash WHEN 1 THEN '能量' WHEN 0 THEN '现金' end as cash,
		soo.company_id,
		soo.ach_price,
		soo.green_count,
		DATE_FORMAT(
		soo.complete_date,
		'%Y-%m-%d'
		) AS dateFor
		FROM
		sb_order soo LEFT JOIN sb_recyclers sr ON soo.recycler_id = sr.id
		WHERE
		1=1
		<if test="startTime !=null and startTime !=''">
			<![CDATA[
							AND soo.complete_date >= CONCAT(#{startTime},' 00:00:00')
						 ]]>
		</if>
		<if test="endTime !=null and endTime !=''">
			<![CDATA[
							AND soo.complete_date <= CONCAT(#{endTime},' 23:59:59')
						 ]]>
		</if>
		<if test="recyclerName !=null and recyclerName !=''">
			AND sr.name_ like CONCAT('%',#{recyclerName},'%')
		</if>
		AND soo.title = #{title}
		and soo.company_id=#{companyId}
		ORDER BY
		dateFor
		) dataInfo ON dataInfo.id = soia.order_id
		) comId ON comId.company_id = scc.id
	</select>
	<select id="outOrderExcel" parameterType="Object" resultType="Map">
			SELECT
			a.order_no AS orderNo,
			date_format(a.create_date,'%Y-%m-%d %H:%i:%S') AS createDate,
			c.name_ AS name,
			bb.name_ AS parentName,
			b.name_ AS categoryName,
			IF (
			a.ach_price > 0,
			'现金',
			'能量'
			) AS isCash,
			ROUND(a.ach_price, 2) AS amount,
			d.name_ AS recyclerName,
			a.admin_commissions AS adminCommissions,
			a.back_commissions_price as backCommissionsPrice
			FROM
			sb_order a
			LEFT JOIN sb_category b ON a.category_id = b.id
			LEFT JOIN sb_category bb ON b.parent_id = bb.id
			LEFT JOIN sb_company c ON a.company_id = c.id
			LEFT JOIN sb_recyclers d ON a.recycler_id = d.id
			WHERE
				a.del_flag = '0'
			AND a.company_id = #{companyId}
			AND a.title = #{type}
			AND a.status_ = 3
			<if test="startTime !=null and startTime !=''">
				<![CDATA[
						AND a.complete_date >= CONCAT(#{startTime},' 00:00:00')
					 ]]>
			</if>
			<if test="endTime !=null and endTime !=''">
				<![CDATA[
						AND a.complete_date <= CONCAT(#{endTime},' 23:59:59')
					 ]]>
			</if>
			<if test="recyclerName !=null and recyclerName !=''">
				AND d.name_ like CONCAT('%',#{recyclerName},'%')
			</if>
	</select>
	<select id="outOrderExcelHouse" parameterType="Object" resultType="Map">
		SELECT
			a.order_no AS orderNo,
			date_format(a.create_date,'%Y-%m-%d %H:%i:%S') AS createDate,
			c.name_ AS name,
			b.parent_name AS parentName,
			b.category_name AS categoryName,
		IF (
			a.is_cash = '0',
			'现金',
			'能量'
		) AS isCash,
		 ROUND(SUM(b.amount), 2) AS amount,
		 d.name_ AS recyclerName
		FROM
			sb_order a
		LEFT JOIN sb_order_item_ach b ON a.id = b.order_id
		LEFT JOIN sb_company c ON a.company_id = c.id
		LEFT JOIN sb_recyclers d ON a.recycler_id = d.id
		WHERE
			a.del_flag = '0'
		AND a.company_id = #{companyId}
		AND a.title = '2'
		AND a.status_ = '3'
		<if test="startTime !=null and startTime !=''">
			<![CDATA[
						AND a.complete_date >= CONCAT(#{startTime},' 00:00:00')
					 ]]>
		</if>
		<if test="endTime !=null and endTime !=''">
			<![CDATA[
						AND a.complete_date <= CONCAT(#{endTime},' 23:59:59')
					 ]]>
		</if>
		<if test="recyclerName !=null and recyclerName !=''">
			AND d.name_ like CONCAT('%',#{recyclerName},'%')
		</if>
		GROUP BY
			b.order_id,
			b.category_name
	</select>
	<select id="getBigOrderTransferList" parameterType="Object" resultType="Map">
		SELECT
			a.id AS recyclerId,
			a.name_ AS recyclerName,
			a.tel AS recyclerMobile,
			d.is_manager AS isManager,
			a.ali_user_id as aliUserId,
			b.id,
			b.title,
			b.status_ AS orderStatus,
			b.link_man AS userName,
			b.tel AS userMobile,
			b.address AS address,
			b.price,
			b.is_cash AS isCash,
			b.order_no AS orderNo,
			b.category_id AS categoryId,
			b.order_remarks as orderRemarks,
			b.complaint_type as complaintType,
			c.name_ AS categoryName,
			c.icon AS icon,
			date_format(b.create_date,'%Y-%m-%d %H:%i:%S') AS createDate,
			CONCAT(date_format(b.arrival_time,'%Y-%m-%d'),IF(b.arrival_period = 'am','上午',IF(b.arrival_period = 'pm','下午',CONCAT(' ',b.arrival_period))))AS arrivalTime,
			date_format(b.cancel_time,'%Y-%m-%d %H:%i:%S')AS cancelTime,
			date_format(b.receive_time,'%Y-%m-%d %H:%i:%S')AS receiveTime,
			date_format(b.distribute_time,'%Y-%m-%d %H:%i:%S') AS distributeTime,
			date_format(b.complete_date,'%Y-%m-%d %H:%i:%S')AS completeDate,
			IF(now()> CONCAT(date_format(b.arrival_time,'%Y-%m-%d'),IF(b.arrival_period = 'pm',' 12:00:00',IF(b.arrival_period = 'am',' 00:00:01',CONCAT(' ',SUBSTR(b.arrival_period,1,2) ,':00:00')))),'Y','N') AS isRead,
			TIMESTAMPDIFF(MINUTE,IF(b.arrival_period='am',CONCAT(b.arrival_time,' 12:00:00'),CONCAT(b.arrival_time,' 18:00:00')), IF(b.status_ = '3',b.complete_date,if(b.status_ in ('4','5'),b.cancel_time,NOW()))) AS overTime
		FROM
			sb_recyclers a
		LEFT JOIN sb_order b ON a.id = b.recycler_id
		LEFT JOIN sb_category c ON c.id = b.category_id
		LEFT JOIN sb_company_recycler d ON a.id = d.recycler_id
		WHERE
			d.parents_id = #{recycleId}
		AND d.status_ = 1
		AND b.title = 4
		AND b.status_ in (1,2)
		AND a.del_flag = 0
		AND b.del_flag = 0
		AND b.is_scan = 0
		order by b.create_date desc
		LIMIT #{startPage},#{endPage}
	</select>
	<select id="getBigOrderTransferCount" parameterType="Integer" resultType="Integer">
		SELECT
		count(1)
		FROM
		sb_recyclers a
		LEFT JOIN sb_order b  force index (idx_recycler_id) ON a.id = b.recycler_id
		LEFT JOIN sb_category c ON c.id = b.category_id
		WHERE
		a.parents_id = #{recycleId}
		AND b.title = 4
		AND b.status_ = 1
		AND a.del_flag = 0
		AND b.del_flag = 0
		AND b.is_scan = 0
	</select>
	<select id="getBigOrderList" parameterType="Object" resultType="Map">
		select * from (
		SELECT
		a.id AS recyclerId,
		a.name_ AS recyclerName,
		a.tel AS recyclerMobile,
		a.ali_user_id as aliUserId,
		b.id,
		b.title,
		b.status_ AS orderStatus,
		b.link_man AS userName,
		b.tel AS userMobile,
		b.address AS address,
		b.price,
		b.cancel_reason AS cancelReason,
		b.ach_price AS achPrice,
		b.is_cash AS isCash,
		b.order_no AS orderNo,
		b.category_id AS categoryId,
		b.order_remarks as orderRemarks,
		b.complaint_type as complaintType,
		c.name_ AS categoryName,
		c.icon AS icon,
		bb.is_manager as  isManager,
		date_format(b.create_date,'%Y-%m-%d %H:%i:%S') AS createDate,
		CONCAT(date_format(b.arrival_time,'%Y-%m-%d'),IF(b.arrival_period = 'am','上午',IF(b.arrival_period = 'pm','下午',CONCAT(' ',b.arrival_period))))AS arrivalTime,
		date_format(b.cancel_time,'%Y-%m-%d %H:%i:%S')AS cancelTime,
		date_format(b.receive_time,'%Y-%m-%d %H:%i:%S')AS receiveTime,
		date_format(b.distribute_time,'%Y-%m-%d %H:%i:%S') AS distributeTime,
		date_format(b.complete_date,'%Y-%m-%d %H:%i:%S')AS completeDate,
		IF(now()> CONCAT(date_format(b.arrival_time,'%Y-%m-%d'),IF(b.arrival_period = 'pm',' 12:00:00',IF(b.arrival_period = 'am',' 00:00:01',CONCAT(' ',SUBSTR(b.arrival_period,1,2) ,':00:00')))),'Y','N') AS isRead,
		TIMESTAMPDIFF(MINUTE,IF(b.arrival_period='am',CONCAT(b.arrival_time,' 12:00:00'),CONCAT(b.arrival_time,' 18:00:00')), IF(b.status_ = '3',b.complete_date,if(b.status_ in ('4','5'),b.cancel_time,NOW()))) AS overTime
		FROM
		sb_order b
		LEFT JOIN sb_recyclers a ON a.id = b.recycler_id
		LEFT JOIN sb_category c ON c.id = b.category_id
		LEFT JOIN sb_company_recycler bb ON bb.recycler_id = b.recycler_id AND bb.company_id = b.company_id
		WHERE
		b.recycler_id = #{recycleId}
		AND b.title = 4
		<choose>
			<when test="status == 4">
				and (b.status_ = 4 or b.status_ = 5)
			</when>
			<otherwise>
				AND b.status_ = #{status}
			</otherwise>
		</choose>
		AND a.del_flag = 0
		AND b.del_flag = 0
		AND b.is_scan = 0
		) b
		<choose>
			<when test="status == '3'.toString()">
				ORDER BY b.completeDate DESC
			</when>
			<when test="status == '2'.toString()">
				ORDER BY b.overTime DESC,b.arrivalTime ASC,b.createDate ASC
			</when>
			<when test="status == '1'.toString()">
				ORDER BY b.overTime DESC,b.arrivalTime ASC,b.createDate DESC
			</when>
			<otherwise>
				ORDER BY b.createDate DESC
			</otherwise>
		</choose>
		LIMIT #{startPage},#{endPage}
	</select>
	<select id="getBigOrderCount" parameterType="Integer" resultType="Integer">
		SELECT
			count(1)
		FROM
		sb_order b
		LEFT JOIN sb_recyclers a ON a.id = b.recycler_id
		LEFT JOIN sb_category c ON c.id = b.category_id
		WHERE
		b.recycler_id = #{recycleId}
		AND b.title = 4
		<choose>
			<when test="status == 4">
				and (b.status_ = 4 or b.status_ = 5)
			</when>
			<otherwise>
				AND b.status_ = #{status}
			</otherwise>
		</choose>
		AND a.del_flag = 0
		AND b.del_flag = 0
		AND b.is_scan = 0
	</select>
	<select id="getBigOrderDetails" parameterType="Integer" resultType="com.tzj.collect.core.result.app.AppOrderResult">
		SELECT
			scomco.order_no AS orderNo,
			sc.name_ AS cateName,
			sc.icon,
			scomco.address,
			scomco.full_address AS fullAddress,
			scomco.complete_date AS completeTime,
			scomco.link_man AS linkName,
			scomco.tel,
			scomco.id AS orderId,
			FORMAT(scomco.price, 2) AS price,
			scomco.ach_price AS achPrice,
			scomco.comTel,
			scomco.comName,
			scomco.status_,
			scomco.arrival_period AS arrivalPeriod,
			scomco.remarks,
			scomco.title,
			scomco.community_id,
			scomco.company_id,
			scomco.ach_remarks,
			scomco.is_cash,
			scomco.sign_url,
			scomco.green_count,
			scomco.order_remarks as orderRemarks,
			sr.is_manager,
			sr.ali_user_id as aliUserId,
		date_format(scomco.create_date,'%Y-%m-%d %H:%i:%S') AS createDate,
		CONCAT(date_format(scomco.arrival_time,'%Y-%m-%d'),IF(scomco.arrival_period = 'am','上午',IF(scomco.arrival_period = 'pm','下午',CONCAT(' ',scomco.arrival_period))))AS arrivalTime,
		date_format(scomco.cancel_time,'%Y-%m-%d %H:%i:%S')AS cancelTime,
		date_format(scomco.receive_time,'%Y-%m-%d %H:%i:%S')AS receiveTime,
		date_format(scomco.distribute_time,'%Y-%m-%d %H:%i:%S') AS distributeTime,
		date_format(scomco.complete_date,'%Y-%m-%d %H:%i:%S')AS completeDate,
		IF(now()> CONCAT(date_format(scomco.arrival_time,'%Y-%m-%d'),IF(scomco.arrival_period = 'pm',' 12:00:00',IF(scomco.arrival_period = 'am',' 00:00:01',CONCAT(' ',SUBSTR(scomco.arrival_period,1,2) ,':00:00')))),'Y','N') AS isRead
		FROM
			(
				SELECT
					scom.name_ AS comName,
					scom.tel AS comTel,
					so.*
				FROM
					sb_company scom
				INNER JOIN sb_order so ON so.company_id = scom.id
				WHERE
					so.del_flag = '0'
					AND so.id = #{orderId}
				) scomco
			LEFT JOIN sb_category sc ON sc.id = scomco.category_id
			LEFT JOIN sb_recyclers sr ON sr.id = scomco.recycler_id
	</select>
	<select id="sevenDayorderNum" parameterType="String" resultType="Map">
		SELECT
			SUBSTR(a.create_date,6,5) AS x,COUNT(1) AS y
		FROM
			sb_order a
		WHERE
			a.street_id = #{streetId}
		AND a.company_id != 1
		AND a.create_date
		AND a.create_date BETWEEN date_sub(CURDATE(), INTERVAL 7 DAY) AND CURDATE()
		GROUP BY SUBSTR(a.create_date,1,10)
	</select>

	<select id="oneDayorderNum" parameterType="String" resultType="Map">
		SELECT
			SUBSTR(a.create_date,12,2) AS x,COUNT(1) AS y,1 as s
		FROM
			sb_order a
		WHERE
			a.street_id = #{streetId}
		AND a.company_id != 1
		AND a.create_date
		AND a.create_date BETWEEN date_sub(CURDATE(), INTERVAL 1 DAY) AND CURDATE()
		GROUP BY SUBSTR(a.create_date,1,13)
	</select>
	<select id="getOrderCountByPhone"  parameterType="String" resultType="Integer">
		SELECT
			IFNULL(count(1),0) AS count_
		FROM
			(
				SELECT
			so.id AS orderId,
			so.create_date AS creatDate,
			so.address,
			so.link_man AS linkName,
			so.tel,
			so.full_address,
			6 AS status_,
			so.price,
			so.ach_price,
			so.order_no orderNo,
			date_format(

				IF (
					ISNULL(so.arrival_time),
					"",
					so.arrival_time
				),
				'%Y-%m-%d'
			) AS arrivalTime,
			so.arrival_period AS arrivalPeriod,
			sc.name_ AS cateName,
			sc.icon,
			so.complete_date completeDate,
			so.title,
			so.community_id,
			so.company_id,
			so.is_cash,
			so.order_remarks,
			sr.is_manager
		FROM
			sb_category sc
		INNER JOIN sb_order so ON so.category_id = sc.id
		LEFT JOIN sb_recycle_cancel_log srcl ON srcl.order_id = so.id
		LEFT JOIN sb_recyclers sr ON sr.id = so.recycler_id
		WHERE
			so.del_flag = '0'
		AND so.title in ('1','2')
		AND srcl.recycler_id = #{orderBean.recyclerId}
		AND so.recycler_id = #{orderBean.recyclerId}
		<if test="orderBean.tel != null and orderBean.tel != '' ">
			AND so.tel like #{orderBean.tel}
		</if>
		<if test="orderBean.orderNo != null and orderBean.orderNo != '' ">
			AND so.order_no like CONCAT('%',#{orderBean.orderNo},'%')
		</if>
		UNION
			SELECT
				so.id AS orderId,
				so.create_date AS creatDate,
				so.address,
				so.link_man AS linkName,
				so.tel,
				so.full_address,
				so.status_,
				FORMAT(so.price, 2) AS price,
				so.ach_price AS achPrice,
				so.order_no orderNo,
				date_format(

					IF (
						ISNULL(so.arrival_time),
						"",
						so.arrival_time
					),
					'%Y-%m-%d'
				) AS arrivalTime,
				so.arrival_period,
				sc.name_ AS cateName,
				sc.icon,
				so.complete_date completeDate,
				so.title,
				so.community_id,
				so.company_id,
				so.is_cash,
				so.order_remarks,
				sr.is_manager
			FROM
				sb_order so
			LEFT JOIN sb_category sc ON so.category_id = sc.id
			LEFT JOIN sb_recyclers sr ON sr.id = so.recycler_id
			WHERE
				so.del_flag = '0'
			AND so.title in ('1','2')
			AND so.recycler_id = #{orderBean.recyclerId}
			<if test="orderBean.tel != null and orderBean.tel != '' ">
				AND so.tel like #{orderBean.tel}
			</if>
			<if test="orderBean.orderNo != null and orderBean.orderNo != '' ">
				AND so.order_no like CONCAT('%',#{orderBean.orderNo},'%')
			</if>
			) countALL
		WHERE
			1 = 1;

	</select>
	<select id="getOrderListByPhone" parameterType="com.tzj.collect.core.param.ali.OrderBean" resultType="com.tzj.collect.core.result.app.AppOrderResult">
	    SELECT
			*
		FROM
			(
			SELECT
				so.id AS orderId,
				so.create_date AS creatDate,
				so.address,
				so.link_man AS linkName,
				so.tel,
				so.full_address,
				so.status_,
				FORMAT(so.price, 2) AS price,
				so.ach_price AS achPrice,
				so.order_no orderNo,
				date_format(

				IF (
				ISNULL(so.arrival_time),
				"",
				so.arrival_time
				),
				'%Y-%m-%d'
				) AS arrivalTime,
				so.arrival_period,
				sc.name_ AS cateName,
				sc.icon,
				so.complete_date completeDate,
				so.title,
				so.community_id,
				so.company_id,
				so.is_cash,
				so.order_remarks,
				sr.is_manager
				FROM
				sb_order so
				LEFT JOIN sb_category sc ON so.category_id = sc.id
				LEFT JOIN sb_recyclers sr ON sr.id = so.recycler_id
				WHERE
				so.del_flag = '0'
				AND so.recycler_id = #{orderBean.recyclerId}
				<if test="orderBean.tel != null and orderBean.tel != '' ">
					AND so.tel like #{orderBean.tel}
				</if>
				<if test="orderBean.orderNo != null and orderBean.orderNo != '' ">
					AND so.order_no like CONCAT('%',#{orderBean.orderNo},'%')
				</if>
			UNION
				SELECT
					so.id AS orderId,
					so.create_date AS creatDate,
					so.address,
					so.link_man AS linkName,
					so.tel,
					so.full_address,
					6 AS status_,
					so.price,
					so.ach_price,
					so.order_no orderNo,
					date_format(

						IF (
							ISNULL(so.arrival_time),
							"",
							so.arrival_time
						),
						'%Y-%m-%d'
					) AS arrivalTime,
					so.arrival_period AS arrivalPeriod,
					sc.name_ AS cateName,
					sc.icon,
					so.complete_date completeDate,
					so.title,
					so.community_id,
					so.company_id,
					so.is_cash,
					so.order_remarks,
					sr.is_manager
				FROM
					sb_category sc
				INNER JOIN sb_order so ON so.category_id = sc.id
				LEFT JOIN sb_recycle_cancel_log srcl ON srcl.order_id = so.id
				LEFT JOIN sb_recyclers sr ON sr.id = so.recycler_id
				WHERE
					so.del_flag = '0'
				AND srcl.recycler_id = #{orderBean.recyclerId}
				AND so.recycler_id = #{orderBean.recyclerId}
				<if test="orderBean.tel != null and orderBean.tel != '' ">
					AND so.tel like #{orderBean.tel}
				</if>
				<if test="orderBean.orderNo != null and orderBean.orderNo != '' ">
					AND so.order_no like CONCAT('%',#{orderBean.orderNo},'%')
				</if>
			) countALL
		WHERE
			1 = 1
		group by  countALL.orderId
		ORDER BY
			countALL.creatDate DESC LIMIT #{startSize} , #{pageSize}
    </select>
	<select id="getBigOrderCountByPhone" parameterType="Integer" resultType="Integer">
		SELECT
			COUNT(1)
		FROM
			(
				SELECT
					b.*
				FROM
					sb_recyclers a
				LEFT JOIN sb_order b ON a.id = b.recycler_id
				LEFT JOIN sb_category c ON c.id = b.category_id
				WHERE
					a.parents_id = #{recycleId}
				AND b.title = 4
				AND b.status_ = 1
				AND a.del_flag = 0
				AND b.del_flag = 0
				AND b.is_scan = 0
				<if test="tel != null and tel != '' ">
					AND b.tel like #{tel}
				</if>
				<if test="orderNo != null and orderNo !='' ">
					AND b.order_no LIKE concat(concat('%',#{orderNo}),'%')
				</if>
				UNION
					SELECT
						b.*
					FROM
						sb_order b
					LEFT JOIN sb_recyclers a ON a.id = b.recycler_id
					LEFT JOIN sb_category c ON c.id = b.category_id
					WHERE
						b.recycler_id = #{recycleId}
					AND b.title = 4
					AND a.del_flag = 0
					AND b.del_flag = 0
					AND b.is_scan = 0
					<if test="tel != null and tel != '' ">
						AND b.tel like #{tel}
					</if>
					<if test="orderNo != null and orderNo !='' ">
						AND b.order_no LIKE concat(concat('%',#{orderNo}),'%')
					</if>
			) countAll

	</select>
	<select id="getBigOrderListByPhone"  parameterType="Object" resultType="Map">
		SELECT
			*
		FROM
			(
				SELECT
					a.id AS recyclerId,
					a.name_ AS recyclerName,
					a.tel AS recyclerMobile,
					a.is_manager AS isManager,
					a.ali_user_id AS aliUserId,
					b.id,
					b.title,
					b.status_ AS orderStatus,
					b.link_man AS userName,
					b.tel AS userMobile,
					b.address AS address,
					b.price,
					b.ach_price AS achPrice,
					b.is_cash AS isCash,
					b.order_no AS orderNo,
					b.category_id AS categoryId,
					b.order_remarks AS orderRemarks,
					c.name_ AS categoryName,
					c.icon AS icon,
					date_format(
						b.create_date,
						'%Y-%m-%d %H:%i:%S'
					) AS createDate,
					CONCAT(
						date_format(b.arrival_time, '%Y-%m-%d'),

					IF (
						b.arrival_period = 'am',
						' 上午',
						IF(b.arrival_period = 'pm','下午',CONCAT(' ',b.arrival_period))
					)
					) AS arrivalTime,
					date_format(
						b.cancel_time,
						'%Y-%m-%d %H:%i:%S'
					) AS cancelTime,
					date_format(
						b.receive_time,
						'%Y-%m-%d %H:%i:%S'
					) AS receiveTime,
					date_format(
						b.distribute_time,
						'%Y-%m-%d %H:%i:%S'
					) AS distributeTime,
					date_format(
						b.complete_date,
						'%Y-%m-%d %H:%i:%S'
					) AS completeDate,

				IF (
					now() > CONCAT(
						date_format(b.arrival_time, '%Y-%m-%d'),

					IF (
						b.arrival_period = 'pm',
						' 12:00:00',
					IF(b.arrival_period = 'am',' 00:00:01',CONCAT(' ',SUBSTR(b.arrival_period,1,2) ,':00:00'))
					)
					),
					'Y',
					'N'
				) AS isRead
				FROM
					sb_recyclers a
				LEFT JOIN sb_order b ON a.id = b.recycler_id
				LEFT JOIN sb_category c ON c.id = b.category_id
				WHERE
					a.parents_id = #{recycleId}
				AND b.title = 4
				AND b.status_ = 1
				AND a.del_flag = 0
				AND b.del_flag = 0
				AND b.is_scan = 0
				<if test="tel != null and tel != '' ">
					AND b.tel like #{tel}
				</if>
				<if test="orderNo != null and orderNo !='' ">
					AND b.order_no LIKE concat(concat('%',#{orderNo}),'%')
				</if>
				UNION
					SELECT
						a.id AS recyclerId,
						a.name_ AS recyclerName,
						a.tel AS recyclerMobile,
						a.is_manager AS isManager,
						a.ali_user_id AS aliUserId,
						b.id,
						b.title,
						b.status_ AS orderStatus,
						b.link_man AS userName,
						b.tel AS userMobile,
						b.address AS address,
						b.price,
						b.ach_price AS achPrice,
						b.is_cash AS isCash,
						b.order_no AS orderNo,
						b.category_id AS categoryId,
						b.order_remarks AS orderRemarks,
						c.name_ AS categoryName,
						c.icon AS icon,
						date_format(
							b.create_date,
							'%Y-%m-%d %H:%i:%S'
						) AS createDate,
						CONCAT(
							date_format(b.arrival_time, '%Y-%m-%d'),

						IF (
							b.arrival_period = 'am',
							' 上午',
							IF(b.arrival_period = 'pm','下午',CONCAT(' ',b.arrival_period))
						)
						) AS arrivalTime,
						date_format(
							b.cancel_time,
							'%Y-%m-%d %H:%i:%S'
						) AS cancelTime,
						date_format(
							b.receive_time,
							'%Y-%m-%d %H:%i:%S'
						) AS receiveTime,
						date_format(
							b.distribute_time,
							'%Y-%m-%d %H:%i:%S'
						) AS distributeTime,
						date_format(
							b.complete_date,
							'%Y-%m-%d %H:%i:%S'
						) AS completeDate,

					IF (
						now() > CONCAT(
							date_format(b.arrival_time, '%Y-%m-%d'),

						IF (
							b.arrival_period = 'pm',
							' 12:00:00',
							IF(b.arrival_period = 'am',' 00:00:01',CONCAT(' ',SUBSTR(b.arrival_period,1,2) ,':00:00'))
						)
						),
						'Y',
						'N'
					) AS isRead
					FROM
						sb_order b
					LEFT JOIN sb_recyclers a ON a.id = b.recycler_id
					LEFT JOIN sb_category c ON c.id = b.category_id
					WHERE
						b.recycler_id = #{recycleId}
					AND b.title = 4
					AND a.del_flag = 0
					AND b.del_flag = 0
					AND b.is_scan = 0
					<if test="tel != null and tel != '' ">
						AND b.tel like #{tel}
					</if>
					<if test="orderNo != null and orderNo !='' ">
						AND b.order_no LIKE concat(concat('%',#{orderNo}),'%')
					</if>
			) countAll WHERE 1 = 1 ORDER BY
		countAll.createDate DESC  LIMIT #{startPage},#{endPage}
	</select>
	<select id="getOrderListByAdmin" parameterType="Object" resultType="Map">
	SELECT
	a.*,
	IF(a.overTime > 2880,'1',if(a.complaintType = '3','1','0')) AS isComplaint
	FROM (
		SELECT
		a.id,
		a.order_no AS orderNo,
		DATE_FORMAT(a.create_date, '%Y-%c-%d %H:%i:%s' ) as categoryDate,
		if(c.title = '1','废弃家电',if(c.title = '2','生活垃圾',if(c.title = '4','大件垃圾','')))AS categoryName,
		c.name_ AS name,
		a.link_man AS userName,
		a.tel,
		a.status_ AS status,
		DATE_FORMAT(a.arrival_time, '%Y-%c-%d' ) as arrivalTime,
		a.arrival_period AS arrivalPeriod,
		(SELECT COUNT(1) FROM sb_arrival_time_log arr WHERE arr.order_id = a.id) AS num,
		d.name_ AS companyName,
		b.name_ AS recyclerName,
		a.complaint_type AS complaintType,
		TIMESTAMPDIFF(MINUTE, IF(a.arrival_period='pm',CONCAT(a.arrival_time,' 18:00:00'),IF(a.arrival_period='am',CONCAT(a.arrival_time,' 12:00:00'),CONCAT(a.arrival_time,' ',SUBSTR(a.arrival_period, 7,5),':00'))),IF(a.status_ = '3',a.complete_date,if(a.status_ in ('4','5'),a.cancel_time,NOW()))) AS overTime
		FROM
		sb_order a
		LEFT JOIN sb_recyclers b ON a.recycler_id = b.id
		LEFT JOIN sb_category c ON a.category_id = c.id
		LEFT JOIN sb_company d ON a.company_id = d.id
		WHERE
		a.del_flag = 0
		and a.title != 5
		<if test="companyId != null and companyId !='' ">
			AND	a.company_id = #{companyId}
		</if>
		<if test="title != null and title !='' ">
			AND a.title = #{title}
		</if>
		<if test="status != null and status !='' ">
			AND a.status_ = #{status}
		</if>
		<if test="tel != null and tel !='' ">
			AND a.tel = #{tel}
		</if>
		<if test="orderNo != null and orderNo !='' ">
			AND a.order_no = #{orderNo}
		</if>
		<if test="linkName != null and linkName !='' ">
			AND a.link_man = #{linkName}
		</if>
		<if test="startTime != null and startTime !='' ">
			AND a.create_date > concat(#{startTime},' 00:00:01')
		</if>
		<if test="endTime != null and endTime !='' ">
			AND concat(#{endTime},' 23:59:59') > a.create_date
		</if>
		ORDER BY a.create_date DESC
	) a
	WHERE
	1 = 1
	<if test="complaintType != null and complaintType !='' ">
		<choose>
			<when test="complaintType=='3'.toString()">
				and a.overTime > 2880 OR a.complaintType = 3
			</when>
			<otherwise>
				and  2880 > a.overTime and a.complaintType = #{complaintType}
			</otherwise>
		</choose>
	</if>
	LIMIT #{startPage},#{pageSize}
	</select>

	<select id="getOrderCountByAdmin" parameterType="Object" resultType="Integer">
	SELECT
		count(1)
	FROM (
		SELECT
		 	a.id,b.id as rId,c.id as cId,
		a.complaint_type AS complaintType,
		TIMESTAMPDIFF(MINUTE, IF(a.arrival_period='pm',CONCAT(a.arrival_time,' 18:00:00'),IF(a.arrival_period='am',CONCAT(a.arrival_time,' 12:00:00'),CONCAT(a.arrival_time,' ',SUBSTR(a.arrival_period, 7,5),':00'))),IF(a.status_ = '3',a.complete_date,if(a.status_ in ('4','5'),a.cancel_time,NOW()))) AS overTime
		FROM
		sb_order a
		LEFT JOIN sb_recyclers b ON a.recycler_id = b.id
		LEFT JOIN sb_category c ON a.category_id = c.id
		LEFT JOIN sb_company d ON a.company_id = d.id
		WHERE
		a.del_flag = 0
		and a.title != 5
		<if test="companyId != null and companyId !='' ">
			AND	a.company_id = #{companyId}
		</if>
		<if test="title != null and title !='' ">
			AND a.title = #{title}
		</if>
		<if test="status != null and status !='' ">
			AND a.status_ = #{status}
		</if>
		<if test="tel != null and tel !='' ">
			AND a.tel = #{tel}
		</if>
		<if test="orderNo != null and orderNo !='' ">
			AND a.order_no = #{orderNo}
		</if>
		<if test="linkName != null and linkName !='' ">
			AND a.link_man = #{linkName}
		</if>
		<if test="startTime != null and startTime !='' ">
			AND a.create_date > concat(#{startTime},' 00:00:01')
		</if>
		<if test="endTime != null and endTime !='' ">
			AND concat(#{endTime},' 23:59:59') > a.create_date
		</if>
	) a
	WHERE
	1 = 1
	<if test="complaintType != null and complaintType !='' ">
		<choose>
			<when test="complaintType=='3'.toString()">
				and a.overTime > 2880 OR a.complaintType = 3
			</when>
			<otherwise>
				and 2880 > a.overTime and a.complaintType = #{complaintType}
			</otherwise>
		</choose>
	</if>
	</select>
	<select id="getOrderListByAdminReception" parameterType="Object" resultType="Map">
	SELECT
			a.*,
			IF(a.overTime > 2880,'1',if(a.complaintType = '3','1','0')) AS isComplaint
	 FROM (
			SELECT
				a.id,
				a.order_no AS orderNo,
				DATE_FORMAT(a.create_date, '%Y-%c-%d %H:%i:%s' ) as createDate,
				if(c.title = '1','废弃家电',if(c.title = '2','生活垃圾',if(c.title = '4','大件垃圾','')))AS categoryName,
				c.name_ AS name,
				a.link_man AS userName,
				a.tel,
				a.status_ AS status,
				b.name_ AS recycleerName,
				d.name_ AS companyName,
				a.complaint_type AS complaintType,
				DATE_FORMAT(a.arrival_time, '%Y-%c-%d' ) as arrivalTime,
				a.arrival_period AS arrivalPeriod,
				(SELECT COUNT(1) FROM sb_arrival_time_log arr WHERE arr.order_id = a.id) AS num,
				TIMESTAMPDIFF(MINUTE, IF(a.arrival_period='pm',CONCAT(a.arrival_time,' 18:00:00'),IF(a.arrival_period='am',CONCAT(a.arrival_time,' 12:00:00'),CONCAT(a.arrival_time,' ',SUBSTR(a.arrival_period, 7,5),':00'))),IF(a.status_ = '3',a.complete_date,if(a.status_ in ('4','5'),a.cancel_time,NOW()))) AS overTime
			FROM
				sb_order a
			LEFT JOIN sb_recyclers b ON a.recycler_id = b.id
			LEFT JOIN sb_category c ON a.category_id = c.id
			LEFT JOIN sb_company d ON a.company_id = d.id
	WHERE
			a.del_flag = 0
		and a.title != 5
		<if test="companyId != null and companyId !='' ">
			AND	a.company_id = #{companyId}
		</if>
		<if test="title != null and title !='' ">
			AND a.title = #{title}
		</if>
		<if test="status != null and status !='' ">
			AND a.status_ = #{status}
		</if>
		<if test="tel != null and tel !='' ">
			AND a.tel = #{tel}
		</if>
		<if test="orderNo != null and orderNo !='' ">
			AND a.order_no = #{orderNo}
		</if>
		<if test="linkName != null and linkName !='' ">
			AND a.link_man = #{linkName}
		</if>
		<if test="startTime != null and startTime !='' ">
			AND a.create_date > concat(#{startTime},' 00:00:01')
		</if>
		<if test="endTime != null and endTime !='' ">
			AND concat(#{endTime},' 23:59:59') > a.create_date
		</if>
		ORDER BY a.create_date DESC
	) a
	WHERE
		1 = 1
		<if test="complaintType != null and complaintType !='' ">
			<choose>
				<when test="complaintType=='3'.toString()">
 					and a.overTime > 2880 OR a.complaintType = 3
				</when>
				<otherwise>
					and  2880 > a.overTime and a.complaintType = #{complaintType}
				</otherwise>
			</choose>
		</if>
	LIMIT #{startPage},#{pageSize}
</select>
<select id="getOrderCountByAdminReception" parameterType="Object" resultType="Integer">
	SELECT
		count(1)
	FROM (
	SELECT
	a.id,
	a.order_no AS orderNo,
	DATE_FORMAT(a.create_date, '%Y-%c-%d %H:%i:%s' ) as createDate,
	if(c.title = '1','废弃家电',if(c.title = '2','生活垃圾',if(c.title = '4','大件垃圾','')))AS categoryName,
	c.name_ AS name,
	a.link_man AS userName,
	a.tel,
	a.status_ AS status,
	b.name_ AS recycleerName,
	d.name_ AS companyName,
	a.complaint_type AS complaintType,
	TIMESTAMPDIFF(MINUTE, IF(a.arrival_period='pm',CONCAT(a.arrival_time,' 18:00:00'),IF(a.arrival_period='am',CONCAT(a.arrival_time,' 12:00:00'),CONCAT(a.arrival_time,' ',SUBSTR(a.arrival_period, 7,5),':00'))),IF(a.status_ = '3',a.complete_date,if(a.status_ in ('4','5'),a.cancel_time,NOW()))) AS overTime
	FROM
	sb_order a
	LEFT JOIN sb_recyclers b ON a.recycler_id = b.id
	LEFT JOIN sb_category c ON a.category_id = c.id
	LEFT JOIN sb_company d ON a.company_id = d.id
	WHERE
	a.del_flag = 0
	and a.title != 5
	<if test="companyId != null and companyId !='' ">
		AND	a.company_id = #{companyId}
	</if>
	<if test="title != null and title !='' ">
		AND a.title = #{title}
	</if>
	<if test="status != null and status !='' ">
		AND a.status_ = #{status}
	</if>
	<if test="tel != null and tel !='' ">
		AND a.tel = #{tel}
	</if>
	<if test="orderNo != null and orderNo !='' ">
		AND a.order_no = #{orderNo}
	</if>
	<if test="linkName != null and linkName !='' ">
		AND a.link_man = #{linkName}
	</if>
	<if test="startTime != null and startTime !='' ">
		AND a.create_date > concat(#{startTime},' 00:00:01')
	</if>
	<if test="endTime != null and endTime !='' ">
		AND concat(#{endTime},' 23:59:59') > a.create_date
	</if>
	) a
	WHERE
	1 = 1
	<if test="complaintType != null and complaintType !='' ">
		<choose>
			<when test="complaintType=='3'.toString()">
				and a.overTime > 2880 OR a.complaintType = 3
			</when>
			<otherwise>
				and 2880 > a.overTime and a.complaintType = #{complaintType}
			</otherwise>
		</choose>
	</if>
</select>
	<select id="getXyOrderListByAdminReception" parameterType="Object" resultType="Map">
		SELECT
		a.*,
		IF(a.overTime > 2880,'1',if(a.complaintType = '3','1','0')) AS isComplaint
		FROM (
		SELECT
		a.id,
		CONCAT(a.qty,'-',a.qty+5) as qty,
		a.order_no AS orderNo,
		DATE_FORMAT(a.create_date, '%Y-%c-%d %H:%i:%s' ) as createDate,
		if(a.title = '1','废弃家电',if(a.title = '2','生活垃圾',if(a.title = '4','大件垃圾','')))AS categoryName,
		a.link_man AS userName,
		a.tel,
		a.address,
		a.status_ AS status,
		b.name_ AS recycleerName,
		a.complaint_type AS complaintType,
		DATE_FORMAT(a.arrival_time, '%Y-%c-%d' ) as arrivalTime,
		a.arrival_period AS arrivalPeriod,
		(SELECT COUNT(1) FROM sb_arrival_time_log arr WHERE arr.order_id = a.id) AS num,
		TIMESTAMPDIFF(MINUTE, IF(a.arrival_period='pm',CONCAT(a.arrival_time,' 18:00:00'),IF(a.arrival_period='am',CONCAT(a.arrival_time,' 12:00:00'),CONCAT(a.arrival_time,' ',SUBSTR(a.arrival_period, 7,5),':00'))),IF(a.status_ = '3',a.complete_date,if(a.status_ in ('4','5'),a.cancel_time,NOW()))) AS overTime
		FROM
		sb_order a
		LEFT JOIN sb_recyclers b ON a.recycler_id = b.id
		WHERE
		a.del_flag = 0
		and a.taobao_no is not null
		<if test="companyId != null and companyId !='' ">
			AND	a.company_id = #{companyId}
		</if>
		<if test="title != null and title !='' ">
			AND a.title = #{title}
		</if>
		<if test="status != null and status !='' ">
			AND a.status_ = #{status}
		</if>
		<if test="orderNo != null and orderNo !='' ">
			AND a.order_no = #{orderNo}
		</if>
		<if test="linkName != null and linkName !='' ">
			AND (a.link_man = #{linkName} or a.tel = #{tel})
		</if>
		<if test="startTime != null and startTime !='' ">
			AND a.create_date > concat(#{startTime},' 00:00:01')
		</if>
		<if test="endTime != null and endTime !='' ">
			AND concat(#{endTime},' 23:59:59') > a.create_date
		</if>
		<if test="isNormal != null and isNormal !='' ">
			<choose>
				<when test="isNormal == '0'.toString()">
					AND (a.company_id is not null and a.company_id != '')
				</when>
				<otherwise>
					AND (a.company_id is null or a.company_id = '')
				</otherwise>
			</choose>
		</if>
		ORDER BY a.create_date DESC
		) a
		LIMIT #{startPage},#{pageSize}
	</select>
	<select id="getXyOrderCountByAdminReception" resultType="Integer" parameterType="Object">
		SELECT
			count(1)
		FROM
		sb_order a
		LEFT JOIN sb_recyclers b ON a.recycler_id = b.id
		WHERE
		a.del_flag = 0
		and a.taobao_no is not null
		<if test="companyId != null and companyId !='' ">
			AND	a.company_id = #{companyId}
		</if>
		<if test="title != null and title !='' ">
			AND a.title = #{title}
		</if>
		<if test="status != null and status !='' ">
			AND a.status_ = #{status}
		</if>
		<if test="orderNo != null and orderNo !='' ">
			AND a.order_no = #{orderNo}
		</if>
		<if test="linkName != null and linkName !='' ">
			AND (a.link_man = #{linkName} or a.tel = #{tel})
		</if>
		<if test="startTime != null and startTime !='' ">
			AND a.create_date > concat(#{startTime},' 00:00:01')
		</if>
		<if test="endTime != null and endTime !='' ">
			AND concat(#{endTime},' 23:59:59') > a.create_date
		</if>
		<if test="isNormal != null and isNormal !='' ">
			<choose>
				<when test="isNormal == '0'.toString()">
					AND (a.company_id is not null and a.company_id != '')
				</when>
				<otherwise>
					AND (a.company_id is null or a.company_id = '')
				</otherwise>
			</choose>
		</if>
		ORDER BY a.create_date DESC
	</select>

	<select id="getOutComplaintOrderList" parameterType="Object" resultType="Map">
		SELECT
		a.*,
		IF(a.overTime > 2880,'1',if(a.complaintType = '3','1','0')) AS isComplaint
		FROM (
		SELECT
		a.id,
		a.order_no AS orderNo,
		h.area_name AS provinceName,
		g.area_name AS cityName,
		f.area_name AS areaName,
		e.area_name AS streetName,
		DATE_FORMAT(a.create_date, '%Y-%c-%d %H:%i:%s' ) as createDate,
		DATE_FORMAT(a.arrival_time, '%Y-%c-%d' ) as arrivalTime,
		a.arrival_period AS arrivalPeriod,
		if(c.title = '1','废弃家电',if(c.title = '2','生活垃圾',if(c.title = '4','大件垃圾','')))AS categoryName,
		c.name_ AS name,
		a.link_man AS userName,
		a.tel,
		a.status_ AS status,
		b.name_ AS recycleerName,
		d.name_ AS companyName,
		if(a.is_cash = '0',a.commissions_price,0) as commissionsPrice,
		if(a.is_cash = '0',0,a.commissions_price) as freeCommissionsPrice,
		a.back_commissions_price as backCommissionsPrice,
		DATE_FORMAT(a.complete_date, '%Y-%c-%d %H:%i:%s' ) as completeDate,
		a.complaint_type AS complaintType,
		(SELECT COUNT(1) FROM sb_order_complaint aa WHERE aa.type_ = 0 AND aa.order_no = a.order_no) AS initCount,
		(SELECT COUNT(1) FROM sb_order_complaint aa WHERE aa.type_ = 1 AND aa.order_no = a.order_no) AS sendCount,
		(SELECT COUNT(1) FROM sb_order_complaint aa WHERE aa.type_ = 2 AND aa.order_no = a.order_no) AS completeCount,
		(SELECT COUNT(1) FROM sb_order_complaint aa WHERE aa.type_ = 4 AND aa.order_no = a.order_no) AS complaintCount,
		(SELECT COUNT(1) FROM sb_order_complaint aa WHERE aa.order_no = a.order_no) AS count,
		TIMESTAMPDIFF(MINUTE, IF(a.arrival_period='pm',CONCAT(a.arrival_time,' 18:00:00'),IF(a.arrival_period='am',CONCAT(a.arrival_time,' 12:00:00'),CONCAT(a.arrival_time,' ',SUBSTR(a.arrival_period, 7,5),':00'))),IF(a.status_ = '3',a.complete_date,if(a.status_ in ('4','5'),a.cancel_time,NOW()))) AS overTime
		FROM
		sb_order a
		LEFT JOIN sb_recyclers b ON a.recycler_id = b.id
		LEFT JOIN sb_category c ON a.category_id = c.id
		LEFT JOIN sb_company d ON a.company_id = d.id
		LEFT JOIN sb_area e ON a.street_id  = e.id
		LEFT JOIN sb_area f ON f.id = a.area_id
		LEFT JOIN sb_area g ON f.parent_id = g.id
		LEFT JOIN sb_area h ON g.parent_id = h.id
		WHERE
		a.del_flag = 0
		<if test="companyId != null and companyId !='' ">
			AND	a.company_id = #{companyId}
		</if>
		<if test="title != null and title !='' ">
			AND a.title = #{title}
		</if>
		<if test="status != null and status !='' ">
			AND a.status_ = #{status}
		</if>
		<if test="tel != null and tel !='' ">
			AND a.tel = #{tel}
		</if>
		<if test="orderNo != null and orderNo !='' ">
			AND a.order_no = #{orderNo}
		</if>
		<if test="linkName != null and linkName !='' ">
			AND a.link_man = #{linkName}
		</if>
		<if test="startTime != null and startTime !='' ">
			AND a.create_date > concat(#{startTime},' 00:00:01')
		</if>
		<if test="endTime != null and endTime !='' ">
			AND concat(#{endTime},' 23:59:59') > a.create_date
		</if>
		) a
		WHERE
		1 = 1
		<if test="complaintType != null and complaintType !='' ">
			<choose>
				<when test="complaintType=='3'.toString()">
					and a.overTime > 2880 OR a.complaintType = 3
				</when>
				<otherwise>
					and 2880 > a.overTime  and a.complaintType = #{complaintType}
				</otherwise>
			</choose>
		</if>
		ORDER BY a.createDate DESC
	</select>

<select id="getOrderComplaint" parameterType="String" resultType="Map">
	SELECT
				a.id,
				a.order_no AS orderNo,
				a.complaint_type AS complaintType,
				DATE_FORMAT(DATE_ADD(IF(a.title = '2',CONCAT(a.arrival_time,' ',SUBSTR(a.arrival_period, 7,5),':00'),IF(a.arrival_period='am',CONCAT(a.arrival_time,' 12:00:00'),CONCAT(a.arrival_time,' 18:00:00'))),interval 2 day),'%Y-%m-%d %H:%i:%s') as dates,
				TIMESTAMPDIFF(MINUTE, IF(a.arrival_period='pm',CONCAT(a.arrival_time,' 18:00:00'),IF(a.arrival_period='am',CONCAT(a.arrival_time,' 12:00:00'),CONCAT(a.arrival_time,' ',SUBSTR(a.arrival_period, 7,5),':00'))),IF(a.status_ = '3',a.complete_date,if(a.status_ in ('4','5'),a.cancel_time,NOW()))) AS overTime
			FROM
				sb_order a
			WHERE
				a.order_no = #{orderNo}
</select>

	<select id="getOrderCountByLj" parameterType="String" resultType="Integer">
		SELECT
			count(1)
		FROM
		sb_order a
		LEFT JOIN sb_area b ON a.area_id = b.id
		WHERE
		a.del_flag = 0
		<if test="cityId != '-1'">
			AND	b.parent_id = #{cityId}
		</if>
		<if test="areaId != '-1'">
			AND a.area_id = #{areaId}
		</if>
		<if test="streetId != '-1'">
			AND a.street_id = #{streetId}
		</if>
	</select>
	<select id="getInitCountByLj" parameterType="String" resultType="Integer">
		SELECT
			count(1)
		FROM
			sb_order a
		LEFT JOIN sb_area b ON a.area_id = b.id
		WHERE
			a.status_ = '0'
		<if test="cityId != '-1'">
			AND	b.parent_id = #{cityId}
		</if>
		<if test="areaId != '-1'">
			AND a.area_id = #{areaId}
		</if>
		<if test="streetId != '-1'">
			AND a.street_id = #{streetId}
		</if>
		<if test="companyId != '-1'">
			AND a.company_id = #{companyId}
		</if>
	</select>
	<select id="getTosendCountByLj" parameterType="String" resultType="Integer">
		SELECT
			count(1)
		FROM
			sb_order a
		LEFT JOIN sb_area b ON a.area_id = b.id
		WHERE
			a.status_ = '1'
		<if test="cityId != '-1'">
			AND	b.parent_id = #{cityId}
		</if>
		<if test="areaId != '-1'">
			AND a.area_id = #{areaId}
		</if>
		<if test="streetId != '-1'">
			AND a.street_id = #{streetId}
		</if>
		<if test="companyId != '-1'">
			AND a.company_id = #{companyId}
		</if>
	</select>
	<select id="getReadyCountByLj" parameterType="String" resultType="Integer">
		SELECT
		count(1)
		FROM
		sb_order a
		LEFT JOIN sb_area b ON a.area_id = b.id
		WHERE
		a.status_ = '2'
		<if test="cityId != '-1'">
			AND	b.parent_id = #{cityId}
		</if>
		<if test="areaId != '-1'">
			AND a.area_id = #{areaId}
		</if>
		<if test="streetId != '-1'">
			AND a.street_id = #{streetId}
		</if>
		<if test="companyId != '-1'">
			AND a.company_id = #{companyId}
		</if>
	</select>
	<select id="getOrderCountBytitle" parameterType="String" resultType="Integer">
		SELECT
			count(1)
		FROM
		sb_order a
		LEFT JOIN sb_area b ON a.area_id = b.id
		WHERE
			a.title = #{title}
		AND a.status_ != '4'
		AND a.status_ != '5'
		<if test="isGreen != null and isGreen != ''">
			AND a.is_cash = #{isGreen}
		</if>
		<if test="cityId != '-1'">
			AND	b.parent_id = #{cityId}
		</if>
		<if test="areaId != '-1'">
			AND a.area_id = #{areaId}
		</if>
		<if test="streetId != '-1'">
			AND a.street_id = #{streetId}
		</if>
		<if test="companyId != '-1'">
			AND a.company_id = #{companyId}
		</if>
		<if test="startDate != null and startDate != ''">
			AND a.create_date > CONCAT(#{startDate}, ' 00:00:01')
		</if>
		<if test="endtDate != null and endtDate != ''">
			AND CONCAT(#{endtDate}, ' 23:59:59') > a.create_date
		</if>
	</select>
	<select id="getGreenBigPaymentOrderPrice" parameterType="String" resultType="Double">
		SELECT
			FORMAT(SUM(a.ach_price)/count(1),2)
		FROM
		sb_order a
		LEFT JOIN sb_area b ON a.area_id = b.id
		WHERE
			a.title = 4
		AND a.status_ = '3'
		<if test="cityId != '-1'">
			AND	b.parent_id = #{cityId}
		</if>
		<if test="areaId != '-1'">
			AND a.area_id = #{areaId}
		</if>
		<if test="streetId != '-1'">
			AND a.street_id = #{streetId}
		</if>
		<if test="companyId != '-1'">
			AND a.company_id = #{companyId}
		</if>
		<if test="startDate != null and startDate != ''">
			AND a.complete_date > CONCAT(#{startDate}, ' 00:00:01')
		</if>
		<if test="endtDate != null and endtDate != ''">
			AND CONCAT(#{endtDate}, ' 23:59:59') > a.complete_date
		</if>
	</select>
	<select id="getOrderCategoryByLj" parameterType="String" resultType="Map">
		SELECT
			c.name_ as categoryName,
			COUNT(1) as amount
		FROM
			sb_order a
		LEFT JOIN sb_category b ON a.category_id = b.id
		LEFT JOIN sb_category c ON b.parent_id = c.id
		LEFT JOIN sb_area d ON a.area_id = d.id
		WHERE
			a.title IN (1, 4)
		AND a.status_ = 3
		<if test="cityId != '-1'">
			AND	d.parent_id = #{cityId}
		</if>
		<if test="areaId != '-1'">
			AND a.area_id = #{areaId}
		</if>
		<if test="streetId != '-1'">
			AND a.street_id = #{streetId}
		</if>
		<if test="companyId != '-1'">
			AND a.company_id = #{companyId}
		</if>
		<if test="startDate != null and startDate != ''">
			AND a.complete_date > CONCAT(#{startDate}, ' 00:00:01')
		</if>
		<if test="endtDate != null and endtDate != ''">
			AND CONCAT(#{endtDate}, ' 23:59:59') > a.complete_date
		</if>
		GROUP BY
			c.id
		ORDER BY
			COUNT(1) DESC;
	</select>
	<select id="getHouseOrderCategoryByLjAsCash" parameterType="String" resultType="Map">
		SELECT
			b.category_name AS categoryName,
			FORMAT(SUM(b.amount),2) AS amount
		FROM
			sb_order a
		LEFT JOIN sb_order_item_ach b ON a.id = b.order_id
		LEFT JOIN sb_area c ON a.area_id = c.id
		WHERE
			a.status_ = 3
		AND a.title = 2
		AND a.is_cash = 0
		<if test="cityId != '-1'">
			AND	c.parent_id = #{cityId}
		</if>
		<if test="areaId != '-1'">
			AND a.area_id = #{areaId}
		</if>
		<if test="streetId != '-1'">
			AND a.street_id = #{streetId}
		</if>
		<if test="companyId != '-1'">
			AND a.company_id = #{companyId}
		</if>
		<if test="startDate != null and startDate != ''">
			AND a.complete_date > CONCAT(#{startDate}, ' 00:00:01')
		</if>
		<if test="endtDate != null and endtDate != ''">
			AND CONCAT(#{endtDate}, ' 23:59:59') > a.complete_date
		</if>
		GROUP BY b.category_name
		ORDER BY b.parent_id
	</select>
	<select id="getHouseOrderCategoryByLjAsGreen" parameterType="String" resultType="Map">
			SELECT
				b.category_name AS categoryName,
				FORMAT(SUM(b.amount),2) AS amount
			FROM
				sb_order a
			LEFT JOIN sb_order_item_ach b ON a.id = b.order_id
			LEFT JOIN sb_area c ON a.area_id = c.id
			WHERE
				a.status_ = 3
			AND a.title =2
			AND a.is_cash = 1
			<if test="cityId != '-1'">
				AND	c.parent_id = #{cityId}
			</if>
			<if test="areaId != '-1'">
				AND a.area_id = #{areaId}
			</if>
			<if test="streetId != '-1'">
				AND a.street_id = #{streetId}
			</if>
			<if test="companyId != '-1'">
				AND a.company_id = #{companyId}
			</if>
			<if test="startDate != null and startDate != ''">
				AND a.complete_date > CONCAT(#{startDate}, ' 00:00:01')
			</if>
			<if test="endtDate != null and endtDate != ''">
				AND CONCAT(#{endtDate}, ' 23:59:59') > a.complete_date
			</if>
			GROUP BY b.category_name
			ORDER BY b.parent_id
	</select>
	<select id="getSumOrderBylj" parameterType="String" resultType="Integer">
		SELECT
		count(1)
		FROM
		sb_order a
		LEFT JOIN sb_area b ON a.area_id = b.id
		WHERE
		a.del_flag = 0
		<if test="cityId != '-1'">
			AND	b.parent_id = #{cityId}
		</if>
		<if test="areaId != '-1'">
			AND a.area_id = #{areaId}
		</if>
		<if test="streetId != '-1'">
			AND a.street_id = #{streetId}
		</if>
		<if test="companyId != '-1'">
			AND a.company_id = #{companyId}
		</if>
		<if test="startDate != null and startDate != ''">
			AND a.create_date > CONCAT(#{startDate}, ' 00:00:01')
		</if>
		<if test="endtDate != null and endtDate != ''">
			AND CONCAT(#{endtDate}, ' 23:59:59') > a.create_date
		</if>
	</select>
	<select id="avgOrMaxDateByOrderAvg" parameterType="String" resultType="Double">
		SELECT
		<choose>
			<when test="status == '1'.toString()">
				AVG(TIMESTAMPDIFF(MINUTE, a.create_date, a.distribute_time))
			</when>
			<otherwise>
				<choose>
					<when test="status == '2'.toString()">
						AVG(TIMESTAMPDIFF(MINUTE, a.create_date, a.receive_time))
					</when>
					<otherwise>
						<choose>
						<when test="title == '1'.toString()">
							AVG(TIMESTAMPDIFF(MINUTE, IF(a.arrival_period='am',CONCAT(a.arrival_time,' 08:00:00'),CONCAT(a.arrival_time,' 12:00:00')), a.complete_date))
						</when>
						<otherwise>
							AVG(TIMESTAMPDIFF(MINUTE, a.create_date, a.complete_date))
						</otherwise>
						</choose>
					</otherwise>
				</choose>
			</otherwise>
		</choose>
		FROM
			sb_order a
		LEFT JOIN sb_area b ON a.area_id = b.id
		WHERE
		<choose>
			<when test="status == '1'.toString()">
				a.distribute_time IS NOT NULL
			</when>
			<otherwise>
				<choose>
					<when test="status == '2'.toString()">
						a.receive_time IS NOT NULL
					</when>
					<otherwise>
						a.complete_date IS NOT NULL
					</otherwise>
				</choose>
			</otherwise>
		</choose>
		  and a.title = #{title}
		<if test="cityId != '-1'">
			AND	b.parent_id = #{cityId}
		</if>
		<if test="areaId != '-1'">
			AND a.area_id = #{areaId}
		</if>
		<if test="streetId != '-1'">
			AND a.street_id = #{streetId}
		</if>
		<if test="companyId != '-1'">
			AND a.company_id = #{companyId}
		</if>
		<if test="startDate != null and startDate != ''">
			AND a.create_date > CONCAT(#{startDate}, ' 00:00:01')
		</if>
		<if test="endtDate != null and endtDate != ''">
			AND CONCAT(#{endtDate}, ' 23:59:59') > a.create_date
		</if>
	</select>
	<select id="avgOrMaxDateByOrderMax" parameterType="String" resultType="Double">
		SELECT
		<choose>
			<when test="status == '1'.toString()">
				MAX(TIMESTAMPDIFF(MINUTE, a.create_date, a.distribute_time))
			</when>
			<otherwise>
				<choose>
					<when test="status == '2'.toString()">
						MAX(TIMESTAMPDIFF(MINUTE, a.create_date, a.receive_time))
					</when>
					<otherwise>
						<choose>
						<when test="title == '1'.toString()">
							MAX(TIMESTAMPDIFF(MINUTE, IF(a.arrival_period='am',CONCAT(a.arrival_time,' 08:00:00'),CONCAT(a.arrival_time,' 12:00:00')), a.complete_date))
						</when>
							<otherwise>
								MAX(TIMESTAMPDIFF(MINUTE, a.create_date, a.complete_date))
							</otherwise>
						</choose>
					</otherwise>
				</choose>
			</otherwise>
		</choose>
		FROM
		sb_order a
		LEFT JOIN sb_area b ON a.area_id = b.id
		WHERE
		<choose>
			<when test="status == '1'.toString()">
				a.distribute_time IS NOT NULL
			</when>
			<otherwise>
				<choose>
					<when test="status == '2'.toString()">
						a.receive_time IS NOT NULL
					</when>
					<otherwise>
						a.complete_date IS NOT NULL
					</otherwise>
				</choose>
			</otherwise>
		</choose>
		and a.title = #{title}
		<if test="cityId != '-1'">
			AND	b.parent_id = #{cityId}
		</if>
		<if test="areaId != '-1'">
			AND a.area_id = #{areaId}
		</if>
		<if test="streetId != '-1'">
			AND a.street_id = #{streetId}
		</if>
		<if test="companyId != '-1'">
			AND a.company_id = #{companyId}
		</if>
		<if test="startDate != null and startDate != ''">
			AND a.create_date > CONCAT(#{startDate}, ' 00:00:01')
		</if>
		<if test="endtDate != null and endtDate != ''">
			AND CONCAT(#{endtDate}, ' 23:59:59') > a.create_date
		</if>
	</select>
	<select id="getOrderLjByStatus" parameterType="String" resultType="Integer">
		SELECT
			count(1)
		FROM
		sb_order a
		LEFT JOIN sb_area b ON a.area_id = b.id
		WHERE
		a.del_flag = 0
		and a.status_ = #{status}
		<if test="cityId != '-1'">
			AND	b.parent_id = #{cityId}
		</if>
		<if test="areaId != '-1'">
			AND a.area_id = #{areaId}
		</if>
		<if test="streetId != '-1'">
			AND a.street_id = #{streetId}
		</if>
		<if test="companyId != '-1'">
			AND a.company_id = #{companyId}
		</if>
		<if test="startDate != null and startDate != ''">
			AND a.create_date > CONCAT(#{startDate}, ' 00:00:01')
		</if>
		<if test="endtDate != null and endtDate != ''">
			AND CONCAT(#{endtDate}, ' 23:59:59') > a.create_date
		</if>
	</select>

	<select id="orderStatistics4Third" parameterType="Object" resultType="com.tzj.collect.core.result.third.ThirdOrderResult">
		SELECT
          a.order_no,
          c.name_ as level3,
          d.name_ as level2,
          CASE a.title
			WHEN 1 THEN
			  '家电数码'
			WHEN 2 THEN
			  '五废'
			WHEN 3 THEN
			  '5公斤废纺衣物回收'
			WHEN 4 THEN
			  '大件垃圾'
			ELSE
			  '其他' end as level1,
		  a.green_count,
		  IFNULL(round(f.amount,2),1) as amount
        FROM
          sb_order a
        INNER JOIN sb_area b ON a.area_id = b.id
        INNER JOIN sb_category c on a.category_id=c.id
        INNER JOIN sb_category d on c.parent_id=d.id
        INNER JOIN sb_company e on a.company_id=e.id
        LEFT  JOIN (SELECT order_id,sum(amount) as amount from sb_order_item_ach GROUP BY order_id) f on a.id=f.order_id
        where b.parent_ids like '%_14634_%'
        and a.status_=3 and a.del_flag=0
		<if test="startTime !=null and startTime !=''">
			<![CDATA[
						AND a.create_date >= CONCAT(#{startTime},' 00:00:00')
					 ]]>
		</if>
		<if test="endTime !=null and endTime !=''">
			<![CDATA[
						AND a.create_date <= CONCAT(#{endTime},' 23:59:59')
					 ]]>
		</if>
        ORDER BY
		a.create_date DESC  LIMIT #{startPage},#{endPage}
	</select>
	<select id="selectHouseAmount" resultType="Map">
		SELECT a.categoryName,ROUND(SUM(a.amount),0) AS amount FROM (
		SELECT
						b.category_name AS categoryName,
						SUM(b.amount) AS amount
					FROM
						sb_order a
					LEFT JOIN sb_order_item_ach b ON a.id = b.order_id
					LEFT JOIN sb_area c ON a.area_id = c.id
					WHERE
						a.status_ = 3
					AND a.title =2
					AND b.price = 0
		GROUP BY b.category_name
		UNION ALL
		SELECT
					b.parent_name AS categoryName,
					SUM(b.amount) AS amount
				FROM
					sb_order a
				LEFT JOIN sb_order_item_ach b ON a.id = b.order_id
				LEFT JOIN sb_area c ON a.area_id = c.id
				WHERE
					a.status_ = 3
				AND a.title = 2
				AND b.price > 0
		GROUP BY b.parent_name
		) a GROUP BY a.categoryName
	</select>

	<select id="getReyclersServiceAbility" parameterType="Object" resultType="Map">
		SELECT
			b.id,
			b.recyclerName,
			b.tel,
			IF(a.count is NULL,0,a.count) as count
		FROM
			(
				SELECT
					b.id,
					b.name_ AS recyclerName,
					b.tel
				FROM
					sb_company_recycler a
				INNER JOIN sb_recyclers b ON a.recycler_id = b.id
				WHERE
					a.status_ = '1'
				AND a.company_id = #{companyId}
			) b
		LEFT JOIN (
				SELECT a.recycler_id,COUNT(1) AS count FROM (
				SELECT
					a.recycler_id,
					a.status_,
		TIMESTAMPDIFF(MINUTE, IF(a.arrival_period='pm',CONCAT(a.arrival_time,' 18:00:00'),IF(a.arrival_period='am',CONCAT(a.arrival_time,' 12:00:00'),CONCAT(a.arrival_time,' ',SUBSTR(a.arrival_period, 7,5),':00'))),IF(a.status_ = '3',a.complete_date,if(a.status_ in ('4','5'),a.cancel_time,NOW()))) AS overTime
				FROM
					sb_order a
				WHERE

					a.company_id = #{companyId}
				<if test="startTime != null and startTime != '' ">
					AND a.create_date > CONCAT(#{startTime}, ' 00:00:01')
				</if>
				<if test="endTime != null and endTime != '' ">
					AND CONCAT(#{endTime}, ' 23:59:59') > a.create_date
				</if>
				AND a.recycler_id is not NULL
				AND a.recycler_id != 0
				) a
				WHERE
				<choose>
					<when test="isOverTime == '0'.toString()">
						0 > a.overTime
					</when>
					<otherwise>
						a.overTime > 0
					</otherwise>
				</choose>
				GROUP BY a.recycler_id
		 ) a ON a.recycler_id = b.id
		WHERE
			1=1
		<if test="recyclerName != null and recyclerName != '' ">
			AND b.recyclerName LIKE CONCAT('%', #{recyclerName}, '%')
		</if>
		<if test="mobile != null and mobile != '' ">
			AND b.tel LIKE CONCAT('%', #{mobile}, '%')
		</if>
		LIMIT #{pageStart} , #{pageSize}
	</select>
	<select id="getReyclersServiceAbilityCount" parameterType="Object" resultType="Integer">
		SELECT
			count(1) as count
		FROM
		(
		SELECT
		b.id,
		b.name_ AS recyclerName,
		b.tel
		FROM
		sb_company_recycler a
		INNER JOIN sb_recyclers b ON a.recycler_id = b.id
		WHERE
		a.status_ = '1'
		AND a.company_id = #{companyId}
		) b
		LEFT JOIN (
		SELECT a.recycler_id,COUNT(1) AS count FROM (
		SELECT
		a.recycler_id,
		a.status_,
		TIMESTAMPDIFF(MINUTE, IF(a.arrival_period='pm',CONCAT(a.arrival_time,' 18:00:00'),IF(a.arrival_period='am',CONCAT(a.arrival_time,' 12:00:00'),CONCAT(a.arrival_time,' ',SUBSTR(a.arrival_period, 7,5),':00'))),IF(a.status_ = '3',a.complete_date,if(a.status_ in ('4','5'),a.cancel_time,NOW()))) AS overTime
		FROM
		sb_order a
		WHERE
		a.company_id = #{companyId}
		<if test="startTime != null and startTime != '' ">
			AND a.create_date > CONCAT(#{startTime}, ' 00:00:01')
		</if>
		<if test="endTime != null and endTime != '' ">
			AND CONCAT(#{endTime}, ' 23:59:59') > a.create_date
		</if>
		AND a.recycler_id is not NULL
		AND a.recycler_id != 0
		) a
		WHERE
		<choose>
			<when test="isOverTime == '0'.toString()">
				0 > a.overTime
			</when>
			<otherwise>
				a.overTime > 0
			</otherwise>
		</choose>
		GROUP BY a.recycler_id
		) a ON a.recycler_id = b.id
		WHERE
		1=1
		<if test="recyclerName != null and recyclerName != '' ">
			AND b.recyclerName LIKE CONCAT('%', #{recyclerName}, '%')
		</if>
		<if test="mobile != null and mobile != '' ">
			AND b.tel LIKE CONCAT('%', #{mobile}, '%')
		</if>
	</select>
	<select id="overTimeOrderListByReyclersId" parameterType="Object" resultType="Map">
		SELECT  *  FROM (
		SELECT
		a.order_no AS orderNo,
		DATE_FORMAT(a.create_date,'%Y-%m-%d %k:%i:%s') AS createDate,
		CONCAT(a.arrival_time,' ',a.arrival_period) AS arrivalTime,
		a.link_man AS linkMan,
		a.tel,
		IF (a.title = '1','废弃家电',IF(a.title = '4','大件垃圾','生活垃圾')) AS categoryName,
		a.status_ AS status,
		TIMESTAMPDIFF(MINUTE, IF(a.arrival_period='pm',CONCAT(a.arrival_time,' 18:00:00'),IF(a.arrival_period='am',CONCAT(a.arrival_time,' 12:00:00'),CONCAT(a.arrival_time,' ',SUBSTR(a.arrival_period, 7,5),':00'))),IF(a.status_ = '3',a.complete_date,if(a.status_ in ('4','5'),a.cancel_time,NOW()))) AS overTime
		FROM
		sb_order a
		WHERE
			a.recycler_id = #{recyclerId}
			AND a.company_id = #{companyId}
		<if test="startTime != null and startTime != '' ">
			AND a.create_date > CONCAT(#{startTime}, ' 00:00:01')
		</if>
		<if test="endTime != null and endTime != '' ">
			AND CONCAT(#{endTime}, ' 23:59:59') > a.create_date
		</if>
		<choose>
			<when test="isBig == 'Y'.toString()">
				AND a.title = '4'
			</when>
			<otherwise>
				AND a.title != '4'
			</otherwise>
		</choose>
		) a
		WHERE
		<choose>
			<when test="isOverTime == '0'.toString()">
				0 > a.overTime
			</when>
			<otherwise>
				a.overTime > 0
			</otherwise>
		</choose>
		order by  a.createDate desc
		LIMIT #{pageStart} , #{pageSize}
	</select>
	<select id="overTimeOrderListCount" parameterType="Object" resultType="Integer">
		SELECT  count(1)  FROM (
		SELECT
		a.order_no AS orderNo,
		a.create_date AS createDate,
		CONCAT(a.arrival_time,' ',a.arrival_period) AS arrivalTime,
		a.link_man AS linkMan,
		a.tel,
		IF (a.title = '1','废弃家电',IF(a.title = '4','大件垃圾','生活垃圾')) AS categoryName,
		a.status_ AS status,
		TIMESTAMPDIFF(MINUTE, IF(a.arrival_period='pm',CONCAT(a.arrival_time,' 18:00:00'),IF(a.arrival_period='am',CONCAT(a.arrival_time,' 12:00:00'),CONCAT(a.arrival_time,' ',SUBSTR(a.arrival_period, 7,5),':00'))),IF(a.status_ = '3',a.complete_date,if(a.status_ in ('4','5'),a.cancel_time,NOW()))) AS overTime
		FROM
		sb_order a
		WHERE
		a.recycler_id = #{recyclerId}
        AND a.company_id = #{companyId}
		<if test="startTime != null and startTime != '' ">
			AND a.create_date > CONCAT(#{startTime}, ' 00:00:01')
		</if>
		<if test="endTime != null and endTime != '' ">
			AND CONCAT(#{endTime}, ' 23:59:59') > a.create_date
		</if>
		<choose>
			<when test="isBig == 'Y'.toString()">
				AND a.title = '4'
			</when>
			<otherwise>
				AND a.title != '4'
			</otherwise>
		</choose>
		) a
		WHERE
		<choose>
			<when test="isOverTime == '0'.toString()">
				0 > a.overTime
			</when>
			<otherwise>
				a.overTime > 0
			</otherwise>
		</choose>
	</select>
	<select id="getRecyclerOrderList" parameterType="Object" resultType="Map">
		SELECT  *  FROM (
		SELECT
		a.order_no AS orderNo,
		DATE_FORMAT(a.create_date,'%Y-%m-%d %k:%i:%s') AS createDate,
		CONCAT(a.arrival_time,' ',a.arrival_period) AS arrivalTime,
		a.link_man AS linkMan,
		a.tel,
        b.name_ AS recyclerName,
        b.tel AS recyclerTel,
		IF (a.title = '1','废弃家电',IF(a.title = '4','大件垃圾','生活垃圾')) AS categoryName,
		a.status_ AS status,
		TIMESTAMPDIFF(MINUTE, IF(a.arrival_period='pm',CONCAT(a.arrival_time,' 18:00:00'),IF(a.arrival_period='am',CONCAT(a.arrival_time,' 12:00:00'),CONCAT(a.arrival_time,' ',SUBSTR(a.arrival_period, 7,5),':00'))),IF(a.status_ = '3',a.complete_date,if(a.status_ in ('4','5'),a.cancel_time,NOW()))) AS overTime
		FROM
		sb_order a
        LEFT JOIN sb_recyclers b ON a.recycler_id = b.id
        LEFT JOIN sb_company_recycler c ON a.recycler_id = c.recycler_id AND a.company_id = c.company_id
		WHERE
		a.company_id = #{companyId}
		AND c.status_ = '1'
		<if test="startTime != null and startTime != '' ">
			AND a.create_date > CONCAT(#{startTime}, ' 00:00:01')
		</if>
		<if test="endTime != null and endTime != '' ">
			AND CONCAT(#{endTime}, ' 23:59:59') > a.create_date
		</if>
        <if test="recyclerName != null and recyclerName != '' ">
            AND b.name_ LIKE CONCAT('%', #{recyclerName}, '%')
        </if>
        <if test="mobile != null and mobile != '' ">
            AND b.tel LIKE CONCAT('%', #{mobile}, '%')
        </if>
		<choose>
			<when test="isBig == 'Y'.toString()">
				AND a.title = '4'
				AND c.type_ = '4'
			</when>
			<otherwise>
				AND a.title != '4'
				AND c.type_ = '1'
			</otherwise>
		</choose>
		) a
		WHERE
		<choose>
			<when test="isOverTime == '0'.toString()">
				0 > a.overTime
			</when>
			<otherwise>
				a.overTime > 0
			</otherwise>
		</choose>
		AND a.recyclerName is NOT NULL
		order by a.recyclerName
	</select>
	<select id="getOrderCancleExamineList" parameterType="Object" resultType="Map">
		SELECT
			DATE_FORMAT(a.create_date,'%Y-%m-%d %H:%i:%S') AS createDate,
			a.order_no AS orderNo,
			IF(c.title = '1','家电数码',IF(c.title = '4','大件垃圾','生活垃圾')) AS title,
			b.link_man AS linkMan,
			b.id,
			b.tel,
			a.cancle_reason AS cancleReason,
			d.name_ AS name,
			DATE_FORMAT(b.arrival_time, '%Y-%c-%d' ) as arrivalTime,
			b.arrival_period AS arrivalPeriod
		FROM
			sb_order_cancle_examine a
		inner JOIN sb_order b ON a.order_no = b.order_no
		inner JOIN sb_category c ON b.category_id = c.id
		inner JOIN sb_company d ON b.company_id = d.id
		WHERE a.status_ = '0'
		and b.status_ = '0'
		<if test="companyId != null and companyId != '' ">
			AND b.company_id = #{companyId}
		</if>
		<if test="orderNo != null and orderNo != '' ">
			AND a.order_no like CONCAT('%',#{orderNo},'%')
		</if>
		<if test="startTime != null and startTime != '' ">
			AND a.create_date > CONCAT(#{startTime},' 00:00:01')
		</if>
		<if test="endTime != null and endTime != '' ">
			AND CONCAT(#{endTime},' 23:59:59') > a.create_date
		</if>
		ORDER BY a.create_date ASC
		LIMIT #{pageStart},#{pageSize}
	</select>
	<select id="getOrderCancleExamineCount" parameterType="Object" resultType="Integer">
		SELECT
			count(1)
		FROM
		sb_order_cancle_examine a
		inner JOIN sb_order b ON a.order_no = b.order_no
		inner JOIN sb_category c ON b.category_id = c.id
		inner JOIN sb_company d ON b.company_id = d.id
		WHERE a.status_ = '0'
		and b.status_ = '0'
		<if test="companyId != null and companyId != '' ">
			AND b.company_id = #{companyId}
		</if>
		<if test="orderNo != null and orderNo != '' ">
			AND a.order_no like CONCAT('%',#{orderNo},'%')
		</if>
		<if test="startTime != null and startTime != '' ">
			AND a.create_date > CONCAT(#{startTime},' 00:00:01')
		</if>
		<if test="endTime != null and endTime != '' ">
			AND CONCAT(#{endTime},' 23:59:59') > a.create_date
		</if>
	</select>
	<update id="updateOrderCompany" parameterType="String">
		UPDATE sb_order
		SET company_id = #{companyId},
		 status_ = 0,
		 recycler_id = NULL
		WHERE
			street_id = #{streetId}
		AND title = #{title}
		AND status_ IN (0, 1, 2)
	</update>

    <select id="getAllOrderMapOverview" resultType="Map" parameterType="String">
        SELECT
		order_.order_id,
        CASE order_.status_
        WHEN 0 THEN
        '待接单'
        WHEN 1 THEN
        '已派送'
        WHEN 2 THEN
        '已接单'
        WHEN 3 THEN
        '已完成'
        WHEN 4 THEN
        '已取消'
        WHEN 5 THEN
        '驳回'
        ELSE
        '其他'
        END AS status_,
        CASE order_.title
        WHEN 1 THEN
        '家电数码'
        WHEN 2 THEN
        '生活垃圾'
        WHEN 3 THEN
        '5公斤废纺衣物回收'
        WHEN 4 THEN
        '大件垃圾'
		WHEN 5 THEN
		'iot订单'
        END AS title,
		IF(order_.isOverTime > 0,'是','否') AS isOverTime,
		IF(order_.isOverTime > 2880,'1',if(order_.complaintType = '3','1','0')) AS isComplaint,
        order_.order_no,
		DATE_FORMAT(order_.create_date, '%Y-%m-%d %k:%i:%s') AS create_date,
        order_.ach_price,
        order_.is_cash,
		order_.complaintType,
        saa.area_name streetName,
        saa2.area_name areaName,
        saa3.area_name cityName,
        saa4.area_name caName
        FROM
        ( select * from (
			SELECT
			id as order_id,
			area_id,
			street_id,
			status_,
			title,
			order_no,
			create_date,
			ach_price,
			is_cash,
			complaint_type AS complaintType,
			TIMESTAMPDIFF(MINUTE, IF(title = '2',CONCAT(arrival_time,' ',SUBSTR(arrival_period, 7,5),':00'),IF(arrival_period='am',CONCAT(arrival_time,' 12:00:00'),CONCAT(arrival_time,' 18:00:00'))),IF(status_ = '3',complete_date,if(status_ in ('4','5'),cancel_time,NOW()))) AS isOverTime
			FROM
			sb_order
			WHERE
			del_flag = 0
			AND company_id = #{companyId}
			AND order_from = '0'
			<if test="categoryType != null and categoryType != ''">
				AND title IN (#{categoryType})
			</if>
			<if test="startTime != null and startTime != '' and endTime != null and endTime != '' ">
				AND create_date BETWEEN #{startTime}
				AND CONCAT(#{endTime}, ' 23:59:59')
			</if>
			<choose>
				<when test="status == null  or status == ''">
				</when>
				<otherwise>
					AND status_ IN (#{status})
				</otherwise>
			</choose>
		) order_
		where 1=1
		<if test="complaintType != null and complaintType !='' ">
			<choose>
				<when test="complaintType=='3'.toString()">
					and order_.isOverTime > 2880 OR order_.complaintType = 3
				</when>
				<otherwise>
					and   2880 > order_.isOverTime and order_.complaintType = #{complaintType}
				</otherwise>
			</choose>
		</if>
		ORDER BY
		create_date DESC
		LIMIT #{pageStart},
		#{pageSize}
        ) order_
        LEFT JOIN sb_area saa ON order_.street_id = saa.id
        LEFT JOIN sb_area saa2 ON order_.area_id = saa2.id
        LEFT JOIN sb_area saa3 ON saa2.parent_id = saa3.id
        LEFT JOIN sb_area saa4 ON saa3.parent_id = saa4.id
    </select>
	<select id="getAllOrderMapOverviewCount" resultType="Integer" parameterType="String">
	select
	 count(1)
	 from (
		SELECT
		id as order_id,
		area_id,
		street_id,
		status_,
		title,
		order_no,
		create_date,
		ach_price,
		is_cash,
		complaint_type AS complaintType,
		TIMESTAMPDIFF(MINUTE, IF(title = '2',CONCAT(arrival_time,' ',SUBSTR(arrival_period, 7,5),':00'),IF(arrival_period='am',CONCAT(arrival_time,' 12:00:00'),CONCAT(arrival_time,' 18:00:00'))),IF(status_ = '3',complete_date,if(status_ in ('4','5'),cancel_time,NOW()))) AS isOverTime
		FROM
		sb_order
		WHERE
		del_flag = 0
		AND company_id = #{companyId}
		AND order_from = '0'
		<if test="categoryType != null and categoryType != ''">
			AND title IN (#{categoryType})
		</if>
		<if test="startTime != null and startTime != '' and endTime != null and endTime != '' ">
			AND create_date BETWEEN #{startTime}
			AND CONCAT(#{endTime}, ' 23:59:59')
		</if>
		<choose>
			<when test="status == null  or status == ''">
			</when>
			<otherwise>
				AND status_ IN (#{status})
			</otherwise>
		</choose>
		) order_
		where 1=1
		<if test="complaintType != null and complaintType !='' ">
			<choose>
				<when test="complaintType=='3'.toString()">
					and order_.isOverTime > 2880 OR order_.complaintType = 3
				</when>
				<otherwise>
					and 2880 > order_.isOverTime and order_.complaintType = #{complaintType}
				</otherwise>
			</choose>
		</if>
	</select>
    <select id="outAchOrderListOverview" resultType="Map" parameterType="String">
        SELECT DISTINCT
        CASE order_.status_
        WHEN 0 THEN
        '待接单'
        WHEN 1 THEN
        '已派送'
        WHEN 2 THEN
        '已接单'
        WHEN 3 THEN
        '已完成'
        WHEN 4 THEN
        '已取消'
        WHEN 5 THEN
        '驳回'
        ELSE
        '其他'
        END AS status_,
        CASE order_.title
        WHEN 1 THEN
        '家电数码'
        WHEN 2 THEN
        '五废'
        WHEN 3 THEN
        '5公斤废纺衣物回收'
        WHEN 4 THEN
        '大件垃圾'
		WHEN 5 THEN
		'iot订单'
        END AS title,
        order_.order_no,
        order_.create_date,
        order_.ach_price,
        order_.is_cash,
        order_.category_name,
        order_.amount,
		IF(order_.isOverTime > 2880,'1',if(order_.complaintType = '3','1','0')) AS isComplaint,
        saa.area_name streetName,
        saa2.area_name areaName,
        saa3.area_name cityName,
        saa4.area_name caName
        FROM
        (
        SELECT DISTINCT
        soo.area_id,
        soo.street_id,
        soo.status_,
        soo.title,
        soo.order_no,
        soo.create_date,
        soo.ach_price,
        soo.is_cash,
		soo.complaint_type AS complaintType,
		TIMESTAMPDIFF(MINUTE, IF(soo.title = '2',CONCAT(soo.arrival_time,' ',SUBSTR(soo.arrival_period, 7,5),':00'),IF(soo.arrival_period='am',CONCAT(soo.arrival_time,' 12:00:00'),CONCAT(soo.arrival_time,' 18:00:00'))),IF(soo.status_ = '3',soo.complete_date,if(soo.status_ in ('4','5'),soo.cancel_time,NOW()))) AS isOverTime,
        soi.category_name,
        soi.amount
        FROM
        sb_order soo
        INNER JOIN sb_order_item soi ON soo.id = soi.order_id
        WHERE
        soo.del_flag = 0
        AND soo.company_id = #{companyId}
        AND soo.order_from = '0'
        <choose>
            <when test="categoryType != null and categoryType != ''">
				AND soo.title = #{categoryType}
            </when>
            <otherwise>
				AND soo.title IN (1)
            </otherwise>
        </choose>
        AND soo.create_date BETWEEN #{startTime} AND CONCAT(#{endTime}, ' 23:59:59')
        AND soo.status_ = 3
        UNION ALL
        SELECT
        soo.area_id,
        soo.street_id,
        soo.status_,
        soo.title,
        soo.order_no,
        soo.create_date,
        soo.ach_price,
        soo.is_cash,
		soo.complaint_type AS complaintType,
		TIMESTAMPDIFF(MINUTE, IF(soo.title = '2',CONCAT(soo.arrival_time,' ',SUBSTR(soo.arrival_period, 7,5),':00'),IF(soo.arrival_period='am',CONCAT(soo.arrival_time,' 12:00:00'),CONCAT(soo.arrival_time,' 18:00:00'))),IF(soo.status_ = '3',soo.complete_date,if(soo.status_ in ('4','5'),soo.cancel_time,NOW()))) AS isOverTime,
        soia.category_name,
        soia.amount
        FROM
        sb_order soo
        INNER JOIN sb_order_item_ach soia ON soo.id = soia.order_id
        WHERE
        soo.status_ = 3
        AND soo.order_from = '0'
        AND soo.del_flag = 0
        <choose>
            <when test="categoryType != null  and categoryType != ''">
				AND soo.title = (#{categoryType})
            </when>
            <otherwise>
				AND soo.title IN (2, 3, 5)
            </otherwise>
        </choose>
        AND soo.company_id = #{companyId}
        AND soo.create_date BETWEEN #{startTime} AND CONCAT(#{endTime}, ' 23:59:59')
        ) order_
        LEFT JOIN sb_area saa ON order_.street_id = saa.id
        LEFT JOIN sb_area saa2 ON order_.area_id = saa2.id
        LEFT JOIN sb_area saa3 ON saa2.parent_id = saa3.id
        LEFT JOIN sb_area saa4 ON saa3.parent_id = saa4.id
		where 1=1
		<if test="complaintType != null and complaintType !='' ">
			<choose>
				<when test="complaintType=='3'.toString()">
					and order_.isOverTime > 2880 OR order_.complaintType = 3
				</when>
				<otherwise>
					and 2880 > order_.isOverTime and order_.complaintType = #{complaintType}
				</otherwise>
			</choose>
		</if>
        ORDER BY
        order_.create_date DESC;
    </select>
    <select id="outOtherOrderListOverview" resultType="Map" parameterType="String">
		SELECT
			DISTINCT
			CASE order_.status_
		WHEN 0 THEN
			'待接单'
		WHEN 1 THEN
			'已派送'
		WHEN 2 THEN
			'已接单'
		WHEN 3 THEN
			'已完成'
		WHEN 4 THEN
			'已取消'
		WHEN 5 THEN
			'驳回'
		ELSE
			'其他'
		END AS status_,
		 CASE order_.title
		WHEN 1 THEN
			'家电数码'
		WHEN 2 THEN
			'五废'
		WHEN 3 THEN
			'5公斤废纺衣物回收'
		WHEN 4 THEN
			'大件垃圾'
		WHEN 5 THEN
		'iot订单'
		END AS title,
		 order_.order_no,
		 order_.create_date,
		 order_.ach_price,
		 order_.is_cash,
		 order_.category_name,
		 order_.amount,
		IF(order_.isOverTime > 2880,'1',if(order_.complaintType = '3','1','0')) AS isComplaint,
		 saa.area_name streetName,
		 saa2.area_name areaName,
		 saa3.area_name cityName,
		 saa4.area_name caName
		FROM
			(
				SELECT
					soo.area_id,
					soo.street_id,
					soo.status_,
					soo.title,
					soo.order_no,
					soo.create_date,
					soo.ach_price,
					soo.is_cash,
					soo.complaint_type AS complaintType,
					TIMESTAMPDIFF(MINUTE, IF(soo.title = '2',CONCAT(soo.arrival_time,' ',SUBSTR(soo.arrival_period, 7,5),':00'),IF(soo.arrival_period='am',CONCAT(soo.arrival_time,' 12:00:00'),CONCAT(soo.arrival_time,' 18:00:00'))),IF(soo.status_ = '3',soo.complete_date,if(soo.status_ in ('4','5'),soo.cancel_time,NOW()))) AS isOverTime,
					soi.category_name,
					soi.amount
				FROM
					sb_order soo
				LEFT JOIN sb_order_item soi ON soo.id = soi.order_id
				WHERE
					soo.del_flag = 0
				AND soo.order_from = '0'
				AND soo.company_id = #{companyId}
				<choose>
					<when test="categoryType != null and categoryType != ''">
						AND soo.title IN (#{categoryType})
					</when>
					<otherwise>
						AND soo.title IN (1,2, 3, 5)
					</otherwise>
				</choose>
				AND soo.create_date BETWEEN #{startTime}
				AND CONCAT(#{endTime}, ' 23:59:59')
                <choose>
                    <when test="status == null  or status == ''">
                        AND soo.status_ NOT IN (3)
                    </when>
                    <otherwise>
                        AND soo.status_ IN (#{status})
                    </otherwise>
                </choose>
				ORDER BY
					soo.create_date DESC
			) order_
		LEFT JOIN sb_area saa ON order_.street_id = saa.id
		LEFT JOIN sb_area saa2 ON order_.area_id = saa2.id
		LEFT JOIN sb_area saa3 ON saa2.parent_id = saa3.id
		LEFT JOIN sb_area saa4 ON saa3.parent_id = saa4.id
		where 1=1
		<if test="complaintType != null and complaintType !='' ">
			<choose>
				<when test="complaintType=='3'.toString()">
					and order_.isOverTime > 2880 OR order_.complaintType = 3
				</when>
				<otherwise>
					and 2880 > order_.isOverTime and order_.complaintType = #{complaintType}
				</otherwise>
			</choose>
		</if>
	</select>
	<select id="getOrderListByTitleStatus" parameterType="String" resultType="Long">
		SELECT
			IF(b.count is null,'0',b.count) AS count
		FROM
			sb_company a
		LEFT JOIN (
			SELECT
				a.company_id,
				COUNT(1) AS count
			FROM
				sb_order a
			WHERE
				a.del_flag = 0
		<if test="title != null and title !='' ">
			AND	a.title = #{title}
		</if>
		<if test="status != null and status !='' ">
			AND a.status_ in(#{status})
		</if>
		<if test="startTime != null and startTime !='' ">
			AND a.create_date > CONCAT(#{startTime},' 00:00:01')
		</if>
		<if test="endTime != null and endTime !='' ">
			AND CONCAT(#{endTime},' 23:59:59')> a.create_date
		</if>
			GROUP BY
				a.company_id
		) b ON a.id = b.company_id
		ORDER BY a.name_;
	</select>
	<select id="getOrderListByCity" parameterType="String" resultType="Long">
		SELECT
			IF (b.count IS NULL, '0', b.count) AS count
		FROM
			sb_area a
		LEFT JOIN (
		SELECT
			b.parent_id,
			COUNT(1) AS count
		FROM
			sb_order a
		LEFT JOIN sb_area b ON a.area_id = b.id
		WHERE
			a.del_flag = 0
		<if test="title != null and title !='' ">
			AND	a.title = #{title}
		</if>
		<if test="startTime != null and startTime !='' ">
			AND a.create_date > CONCAT(#{startTime},' 00:00:01')
		</if>
		<if test="endTime != null and endTime !='' ">
			AND CONCAT(#{endTime},' 23:59:59')> a.create_date
		</if>
		GROUP BY
			b.parent_id
		) b ON a.id = b.parent_id
		LEFT JOIN sb_area c ON a.parent_id = c.id
		WHERE
			a.type = 1
		ORDER BY
			a.area_name
	</select>
	<select id="getOrderCancelByCompany" parameterType="String" resultType="Map">
		SELECT
			b.name_ AS name,
			a.order_no AS orderNo,
			IF(a.title = '1','家电',IF(a.title = '4','大件','生活垃圾')) AS title,
			DATE_FORMAT(a.create_date, '%Y-%m-%d %k:%i:%s') AS createDate,
			a.cancel_reason AS cancelReason,
			IF(a.status_ = '4','用户取消','平台取消') AS status
		FROM
			sb_order a
		LEFT JOIN sb_company b ON a.company_id = b.id
		WHERE
			a.del_flag = 0
		<if test="startTime != null and startTime !='' ">
			AND a.create_date > CONCAT(#{startTime},' 00:00:01')
		</if>
		<if test="endTime != null and endTime !='' ">
			AND CONCAT(#{endTime},' 23:59:59')> a.create_date
		</if>
		AND a.status_ in ('4','5')
		ORDER BY a.create_date
	</select>
	<select id="outOrderListByRecycler" parameterType="String" resultType="Long">
		SELECT
			IF(b.count is null,'0',b.count) as count
		FROM
			sb_recyclers a
		LEFT JOIN (
		SELECT
			a.recycler_id,
			COUNT(1) AS count
		FROM
			sb_order a
		WHERE
			a.status_ = 3
		<if test="startTime != null and startTime !='' ">
			AND a.create_date > CONCAT(#{startTime},' 00:00:01')
		</if>
		<if test="endTime != null and endTime !='' ">
			AND CONCAT(#{endTime},' 23:59:59')> a.create_date
		</if>
		<if test="isOverTime != null and isOverTime !='' ">
			<choose>
				<when test="isOverTime == '0'.toString()">
					AND CONCAT(a.arrival_time,IF(a.arrival_period = 'am',' 12:00:00',if(a.arrival_period = 'pm',' 18:00:00',CONCAT(' ',SUBSTR(a.arrival_period,7,5),':00')))) > a.complete_date
				</when>
				<otherwise>
					AND a.complete_date > CONCAT(a.arrival_time,IF(a.arrival_period = 'am',' 12:00:00',if(a.arrival_period = 'pm',' 18:00:00',CONCAT(' ',SUBSTR(a.arrival_period,7,5),':00'))))
				</otherwise>
			</choose>
		</if>
		GROUP BY
			a.recycler_id
		) b ON a.id = b.recycler_id
		ORDER BY a.name_;
	</select>
	<select id="outOrderListGroupCompany" parameterType="String" resultType="Long">
		SELECT
			IF(b.count is null,'0',b.count)
		FROM
			sb_company a
		LEFT JOIN (
			SELECT
				a.company_id,
				COUNT(1) AS count
			FROM
				sb_order a
			WHERE
				a.status_ = 3
				<if test="startTime != null and startTime !='' ">
					AND a.create_date > CONCAT(#{startTime},' 00:00:01')
				</if>
				<if test="endTime != null and endTime !='' ">
					AND CONCAT(#{endTime},' 23:59:59')> a.create_date
				</if>
				AND a.complete_date > CONCAT(a.arrival_time,IF(a.arrival_period = 'am',' 12:00:00',if(a.arrival_period = 'pm',' 18:00:00',CONCAT(' ',SUBSTR(a.arrival_period,1,5),':00'))))
			GROUP BY
			a.company_id
		) b ON a.id = b.company_id
		ORDER BY a.name_
	</select>
	<select id="getManyOrderListByDate" parameterType="String" resultType="Integer">
		SELECT
			COUNT(1)
		FROM
			(
				SELECT
					a.ali_user_id,
					count(1) AS count
				FROM
					sb_order a
				WHERE
					a.del_flag = 0
			<if test="status != null and status !='' ">
				AND a.status_ = #{status}
			</if>
			<if test="title != null and title !='' ">
				AND a.title = #{title}
			</if>
			<if test="startTime != null and startTime !='' ">
				AND a.create_date > CONCAT(#{startTime},' 00:00:01')
			</if>
			<if test="endTime != null and endTime !='' ">
				AND CONCAT(#{endTime},' 23:59:59')> a.create_date
			</if>
				GROUP BY
					a.ali_user_id
			) a
		WHERE
			a.count > 1
	</select>

	<select id="selectIotRecList" resultType="Map" parameterType="Object">
		SELECT
			'塑料瓶/金属瓶' AS type,
			sce.current_value,
			sce.is_close,
			soeqcode.*, sell.location
		FROM
			sb_company_equipment sce
		INNER JOIN (
			SELECT
				soo.id,
				soo.order_no,
				soo.iot_equipment_code,
				soo.create_date
			FROM
				sb_order soo
			WHERE
				soo.del_flag = 0
			AND soo.recycler_id = #{recId}
			AND soo.title = 6
			AND soo.status_ = #{status}
			ORDER BY id DESC
			LIMIT #{pageStart},#{pageSize}
		) soeqcode ON soeqcode.iot_equipment_code = sce.hardware_code
		INNER JOIN sb_equipment_location_list sell ON sell.equipment_code = sce.hardware_code
		INNER JOIN (
			SELECT
				MAX(create_date) AS maxDate,
				equipment_code
			FROM
				sb_equipment_location_list
			WHERE
				del_flag = 0
			GROUP BY equipment_code
		) maxList ON maxList.equipment_code = sell.equipment_code
		AND sell.create_date = maxList.maxDate
		GROUP BY
			sell.equipment_code
	</select>
	<select id="getAmountByOrderId" parameterType="Long" resultType="Double">
		SELECT
			SUM(a.amount)
		FROM
			sb_order_item_ach a
		WHERE
			a.order_id = #{orderId}
	</select>
	<!--B端订单详情中的回收物信息-->
	<select id="getCategoryInfoByOrderId" parameterType="object" resultMap="categoryResultMap">
		SELECT
		c.category_id categoryId,
		if(b.title = 1,'废弃家电',if(b.title = 2,'生活垃圾','生活垃圾/废弃家电')) title,
		c.order_id orderId,
		c.category_name categoryName,
		c.parent_id parentId,
		c.parent_name parentName,
		c.amount,
		c.unit,
		c.price,
		c.company_point AS point,
		CAST(c.amount*c.price AS DECIMAL(20,2))AS priceCount
		FROM
		sb_category b
		JOIN sb_order_item_ach c ON b.id = c.category_id
		WHERE
		c.order_id = #{orderId}
		<if test="title != null and title !='' ">
			AND b.title = #{title}
		</if>
	</select>
	<resultMap id="categoryResultMap" type="com.tzj.collect.core.param.ali.BusinessOrderItemBean">
		<id property="parentId" column="parentId" />
		<result property="parentName" column="parentName" />
		<result property="title" column="title"/>
		<collection property="businessOrderItemList" ofType="com.tzj.collect.core.param.ali.BusinessOrderItemBean">
			<id property="categoryId" column="categoryId" />
			<result property="orderId" column="orderId" />
			<result property="categoryName" column="categoryName" />
			<result property="amount" column="amount"/>
			<result property="unit" column="unit"/>
			<result property="price" column="price"/>
			<result property="point" column="point"/>
			<result property="title" column="title"/>
			<result property="priceCount" column="priceCount"/>
		</collection>
	</resultMap>
	<!-- 使用resultMap映射实体类和字段之间的一一对应关系 -->
	<resultMap type="com.tzj.collect.entity.Order" id="OrderResultMap">
        <id property="id" column="id" />
        <result property="memberId" column="member_id" />
        <result property="companyId" column="company_id" />
        <result property="recyclerId" column="recycler_id" />
        <result property="status" column="status_" typeHandler="org.apache.ibatis.type.EnumOrdinalTypeHandler"/>
        <result property="orderNo" column="order_no" />
        <result property="orderFrom" column="order_from" />
        <result property="netId" column="net_id" />
		<result property="netName" column="net_name" />
		<result property="paymentType" column="payment_type" />
		<result property="payType" column="pay_type" />
		<result property="companyPoint" column="company_point" />
        <result property="areaId" column="area_id" />
        <result property="communityId" column="community_id" />
        <result property="address" column="address" />
        <result property="tel" column="tel" />
        <result property="linkMan" column="link_man" />
        <result property="categoryId" column="category_id" />
        <result property="categoryParentIds" column="category_parent_ids" />
        <result property="price" column="price" />
        <result property="unit" column="unit" />
        <result property="qty" column="qty" />
        <result property="completeDate" column="complete_date" />
        <result property="isEvaluated" column="is_evaluated" />
        <result property="cancelReason" column="cancel_reason" />
        <result property="cancelTime" column="cancel_time" />
        <result property="level" column="level" />
        <result property="receiveTime" column="receive_time" />
        <result property="distributeTime" column="distribute_time" />
        <result property="arrivalTime" column="arrival_time" />
        <result property="arrivalPeriod" column="arrival_period" />
        <result property="greenCode" column="green_code" />
        <result property="aliUserId" column="ali_user_id" />
        <result property="createBy" column="create_by" />
        <result property="createDate" column="create_date" />
        <result property="updateDate" column="update_date" />
        <result property="delFlag" column="del_flag" />
        <result property="achPrice" column="ach_price" />
		<result property="discountPrice" column="discount_price"/>
        <result property="remarks" column="remarks" />
        <result property="achRemarks" column="ach_remarks" />
        <result property="title" column="title" typeHandler="org.apache.ibatis.type.EnumOrdinalTypeHandler"/>
        <result property="isDistributed" column="is_distributed" />
        <result property="num" column="num" />
        <result property="signUrl" column="sign_url" />
         <result property="isCash" column="is_cash" />
         <result property="isScan" column="is_scan" />
		<result property="isRead" column="is_read" />
		<result property="isRisk" column="is_risk" />
		<result property="paymentPrice" column="paymentPrice"/>
		<result property="greenCount" column="green_count"/>
		<result property="enterpriseCode" column="enterprise_code"/>
		<result property="expressAmount" column="express_amount"/>
		<result property="expressNo" column="express_no"/>
		<result property="expressName" column="express_name"/>
		<result property="expressTel" column="express_tel"/>
		<result property="logisticsId" column="logistics_id"/>
		<result property="logisticsName" column="logistics_name"/>
		<result property="iotEquipmentCode" column="iot_equipment_code"/>
		<result property="overTime" column="overTime"/>
		<result property="overTimes" column="overTimes"/>
		<result property="examineReason" column="examineReason"/>
		<result property="examineStatus" column="examineStatus"/>
		<result property="isComplaint" column="isComplaint"/>
		<result property="complaintType" column="complaint_type"/>
		<result property="isItemAch" column="is_item_ach"/>
		<result property="commissionsPrice" column="commissions_price"/>
		<result property="adminCommissions" column="admin_commissions"/>
		<result property="companyCommissions" column="company_commissions"/>
		<result property="backCommissionsPrice" column="back_commissions_price"/>
		<result property="cleanUp" column="clean_up"/>
        <association property="category" javaType="com.tzj.collect.entity.Category">
            <result property="categoryId" column="categoryId" />
            <result property="name" column="name_" />
            <result property="icon" column="icon" />
            <!--<result property="title" column="title"  typeHandler="org.apache.ibatis.type.EnumOrdinalTypeHandler"/>-->
        </association>
        <association property="recyclers" javaType="com.tzj.collect.entity.Recyclers">
            <result property="name" column="Recyclers_name" />
            <result property="tel" column="BTel" />
			<result property="headPicUrl" column="headPicUrl" />
		</association>
    </resultMap>
	<sql id="zd">
		a.id,
		a.member_id,
		a.company_id,
		a.recycler_id,
		a.status_,
		a.order_no,
		a.order_from,
		a.net_id,
		a.net_name,
		a.payment_type,
		a.pay_type,
		a.company_point,
		a.area_id,
		a.community_id,
		a.address,
		a.tel,
		a.link_man,
		a.category_id,
		a.category_parent_ids,
		a.price,
		a.unit,
		a.qty,
		a.complete_date,
		a.is_evaluated,
		a.cancel_reason,
		a.cancel_time,
		a. LEVEL,
		a.arrival_time,
		a.arrival_period,
		a.green_code,
		a.ali_user_id,
		a.create_by,
		a.create_date,
		a.update_date,
		a.del_flag,
		a.remarks,
		a.receive_time,
		a.distribute_time,
		a.is_distributed,
		a.title,
		a.ach_price,
		IFNULL(discount_price, ach_price) as discount_price,
		a.ach_remarks,
		a.sign_url,
		a.is_cash,
		a.is_scan,
		a.is_read,
		a.is_risk,
		a.green_count,
		a.enterprise_code,
		a.express_amount,
		a.express_no,
		a.express_name,
		a.express_tel,
		a.logistics_id,
		a.logistics_name,
		a.iot_equipment_code,
		a.complaint_type,
		a.is_item_ach,
		a.commissions_price,
		a.admin_commissions,
		a.company_commissions,
		a.back_commissions_price,
		a.clean_up,
		c.name_,
		c.icon
	</sql>


</mapper>

